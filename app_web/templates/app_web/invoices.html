{% extends "base.html" %}
{% load static %}

{% block title %}Invoices - Finance Insights{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{% static 'app_web/invoices.css' %}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
{% endblock %}

{% block content %}
<div class="invoices-page">
  <div class="page-header">
    <h1>Invoices</h1>
    <button class="btn btn-primary" onclick="openCreateInvoiceModal()">
      <span>+</span> Create Invoice
    </button>
  </div>

  <!-- Statistics Cards -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-label">Total Invoiced</div>
      <div class="stat-value">£{{ stats.total_invoiced|floatformat:2 }}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Paid</div>
      <div class="stat-value text-success">£{{ stats.total_paid|floatformat:2 }}</div>
      <div class="stat-meta">{{ stats.paid_count }} invoices</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Outstanding</div>
      <div class="stat-value text-warning">£{{ stats.outstanding|floatformat:2 }}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Overdue</div>
      <div class="stat-value text-danger">£{{ stats.overdue|floatformat:2 }}</div>
      <div class="stat-meta">{{ stats.overdue_count }} invoices</div>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters-bar">
    <div class="filter-group">
      <input type="text" id="search" class="filter-search" placeholder="Search invoices..." value="{{ search_query }}">

      <select id="status-filter" class="filter-select">
        <option value="">All Statuses</option>
        <option value="draft" {% if status_filter == 'draft' %}selected{% endif %}>Draft</option>
        <option value="sent" {% if status_filter == 'sent' %}selected{% endif %}>Sent</option>
        <option value="paid" {% if status_filter == 'paid' %}selected{% endif %}>Paid</option>
        <option value="partially_paid" {% if status_filter == 'partially_paid' %}selected{% endif %}>Partially Paid</option>
        <option value="overdue" {% if status_filter == 'overdue' %}selected{% endif %}>Overdue</option>
      </select>

      <select id="client-filter" class="filter-select">
        <option value="">All Clients</option>
        {% for client in clients %}
          <option value="{{ client.id }}" {% if client_filter == client.id|stringformat:"s" %}selected{% endif %}>
            {{ client.name }}{% if client.company %} ({{ client.company }}){% endif %}
          </option>
        {% endfor %}
      </select>

      <input type="date" id="date-from" class="filter-date" value="{{ date_from }}" placeholder="From">
      <input type="date" id="date-to" class="filter-date" value="{{ date_to }}" placeholder="To">

      <button class="btn btn-secondary btn-filter" onclick="applyFilters()">Apply</button>
      <button class="btn btn-secondary btn-filter" onclick="clearFilters()">Clear</button>
    </div>
  </div>

  <!-- Invoices Table -->
  <div class="card">
    <table class="invoices-table">
      <thead>
        <tr>
          <th>Invoice #</th>
          <th>Client</th>
          <th>Date</th>
          <th>Due Date</th>
          <th>Status</th>
          <th>Amount</th>
          <th>Paid</th>
          <th>Balance</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="invoices-tbody">
        {% for invoice in invoices %}
        <tr data-invoice-id="{{ invoice.id }}">
          <td><strong>{{ invoice.invoice_number }}</strong></td>
          <td>
            {{ invoice.client.name }}
            {% if invoice.client.company %}<br><small>{{ invoice.client.company }}</small>{% endif %}
          </td>
          <td>{{ invoice.invoice_date }}</td>
          <td>{{ invoice.due_date }}</td>
          <td>
            <span class="status-badge status-{{ invoice.status }}">
              {{ invoice.status_display }}
            </span>
          </td>
          <td>{{ invoice.currency }} {{ invoice.total|floatformat:2 }}</td>
          <td>{{ invoice.currency }} {{ invoice.paid_amount|floatformat:2 }}</td>
          <td>
            <strong class="{% if invoice.balance_due > 0 %}text-danger{% endif %}">
              {{ invoice.currency }} {{ invoice.balance_due|floatformat:2 }}
            </strong>
          </td>
          <td class="actions-cell">
            <!-- Icon-only action buttons: view (PDF), edit, send (if draft), remind (if unpaid), pay (if unpaid), delete -->
            <button class="btn-icon btn-icon-view" onclick="viewInvoice({{ invoice.id }})" title="View invoice" aria-label="View invoice {{ invoice.invoice_number }}">
              <!-- file / PDF icon -->
              <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M14 2v6h6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </button>

            <button class="btn-icon btn-icon-edit" onclick="editInvoice({{ invoice.id }})" title="Edit invoice" aria-label="Edit invoice {{ invoice.invoice_number }}">
              <!-- edit/pencil icon -->
              <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M3 21v-3.75L14.06 6.19a2 2 0 0 1 2.83 0l1.92 1.92a2 2 0 0 1 0 2.83L7.75 21H3z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </button>

            {% if invoice.status == 'draft' %}
              <button class="btn-icon btn-icon-send" onclick="sendInvoice({{ invoice.id }})" title="Send invoice" aria-label="Send invoice {{ invoice.invoice_number }}">
                <!-- paper-plane/send icon -->
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M22 2L11 13" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M22 2L15 22l-4-9-9-4 18-7z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
              </button>
            {% endif %}

            {% if invoice.balance_due > 0 and invoice.status != 'draft' %}
              <button class="btn-icon btn-icon-remind" onclick="sendReminder({{ invoice.id }})" title="Send reminder" aria-label="Send reminder for invoice {{ invoice.invoice_number }}">
                <!-- bell/reminder icon -->
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M15 17h5l-1.405-1.405A2.032 2.032 0 0 1 18 14.158V11a6 6 0 0 0-5-5.917V4a2 2 0 1 0-4 0v1.083A6 6 0 0 0 4 11v3.159c0 .538-.214 1.055-.595 1.436L2 17h5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M13.73 21a2 2 0 0 1-3.46 0" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
              </button>
            {% endif %}

            {% if invoice.balance_due > 0 %}
              <button class="btn-icon btn-icon-pay" onclick="recordPayment({{ invoice.id }})" title="Record payment" aria-label="Record payment for invoice {{ invoice.invoice_number }}">
                <!-- credit card / pay icon -->
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><rect x="2" y="5" width="20" height="14" rx="2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M2 10h20" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
              </button>
            {% endif %}

            <button class="btn-icon btn-icon-delete" onclick="deleteInvoice({{ invoice.id }})" title="Delete invoice" aria-label="Delete invoice {{ invoice.invoice_number }}">
              <!-- trash icon -->
              <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><polyline points="3 6 5 6 21 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M10 11v6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M14 11v6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </button>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="9" class="text-center">No invoices found</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Create/Edit Invoice Modal -->
<div id="invoice-modal" class="modal-backdrop" style="display: none;">
  <div class="modal modal-large">
    <div class="modal-header">
      <h2 id="modal-title">Create Invoice</h2>
      <button class="modal-close" onclick="closeInvoiceModal()">×</button>
    </div>
    <div class="modal-body">
      <form id="invoice-form">
        <div class="form-row">
          <div class="form-group">
            <label for="client-select">Client *</label>
            <select id="client-select" required>
              <option value="">Select a client...</option>
              {% for client in clients %}
                <option value="{{ client.id }}">{{ client.name }}{% if client.company %} ({{ client.company }}){% endif %}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group">
            <label for="invoice-date">Invoice Date *</label>
            <input type="date" id="invoice-date" required>
          </div>
          <div class="form-group">
            <label for="due-date">Due Date *</label>
            <input type="date" id="due-date" required>
          </div>
        </div>

        <div class="form-group">
          <label>Line Items</label>
          <div id="line-items">
            <!-- Line items will be added here -->
          </div>
          <button type="button" class="btn btn-secondary" onclick="addLineItem()">+ Add Line Item</button>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="tax-rate">Tax Rate (%)</label>
            <input type="number" id="tax-rate" step="0.01" value="0" min="0" max="100">
          </div>
          <div class="form-group">
            <label for="discount">Discount (£)</label>
            <input type="number" id="discount" step="0.01" value="0" min="0">
          </div>
        </div>

        <div class="form-group">
          <label for="notes">Notes</label>
          <textarea id="notes" rows="3"></textarea>
        </div>

        <div class="form-group">
          <label for="terms">Payment Terms</label>
          <textarea id="terms" rows="3"></textarea>
        </div>

        <div class="invoice-totals">
          <div class="total-row">
            <span>Subtotal:</span>
            <span id="subtotal-display">£0.00</span>
          </div>
          <div class="total-row">
            <span>Tax:</span>
            <span id="tax-display">£0.00</span>
          </div>
          <div class="total-row">
            <span>Discount:</span>
            <span id="discount-display">£0.00</span>
          </div>
          <div class="total-row total-final">
            <span>Total:</span>
            <span id="total-display">£0.00</span>
          </div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeInvoiceModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveInvoice()">Save Invoice</button>
    </div>
  </div>
</div>

<!-- Payment Modal -->
<div id="payment-modal" class="modal-backdrop" style="display: none;">
  <div class="modal">
    <div class="modal-header">
      <h2>Record Payment</h2>
      <button class="modal-close" onclick="closePaymentModal()">×</button>
    </div>
    <div class="modal-body">
      <form id="payment-form">
        <div class="form-group">
          <label for="payment-amount">Amount *</label>
          <input type="number" id="payment-amount" step="0.01" required>
        </div>
        <div class="form-group">
          <label for="payment-date">Payment Date *</label>
          <input type="date" id="payment-date" required>
        </div>
        <div class="form-group">
          <label for="payment-method">Payment Method</label>
          <select id="payment-method">
            <option value="bank_transfer">Bank Transfer</option>
            <option value="card">Card</option>
            <option value="cash">Cash</option>
            <option value="cheque">Cheque</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="form-group">
          <label for="payment-reference">Reference</label>
          <input type="text" id="payment-reference">
        </div>
        <div class="form-group">
          <label for="payment-notes">Notes</label>
          <textarea id="payment-notes" rows="3"></textarea>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closePaymentModal()">Cancel</button>
      <button class="btn btn-primary" onclick="savePayment()">Record Payment</button>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-modal" class="modal-backdrop" style="display: none;">
  <div class="modal modal-small">
    <div class="modal-header">
      <h2>Delete Invoice</h2>
      <button class="modal-close" onclick="closeDeleteModal()">×</button>
    </div>
    <div class="modal-body">
      <p>Are you sure you want to delete this invoice? This action cannot be undone.</p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
      <button class="btn btn-danger" onclick="confirmDeleteInvoice()">Delete Invoice</button>
    </div>
  </div>
</div>

<!-- Send Confirmation Modal -->
<div id="send-modal" class="modal-backdrop" style="display: none;">
  <div class="modal modal-small">
    <div class="modal-header">
      <h2>Send Invoice</h2>
      <button class="modal-close" onclick="closeSendModal()">×</button>
    </div>
    <div class="modal-body">
      <p>Are you sure you want to mark this invoice as sent?</p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeSendModal()">Cancel</button>
      <button class="btn btn-primary" onclick="confirmSendInvoice()">Send Invoice</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="{% static 'app_web/invoices.js' %}"></script>
<script>
  // Initialize Flatpickr on all date inputs
  document.addEventListener('DOMContentLoaded', function() {
    flatpickr('#date-from', { dateFormat: 'Y-m-d' });
    flatpickr('#date-to', { dateFormat: 'Y-m-d' });
    flatpickr('#invoice-date', { dateFormat: 'Y-m-d' });
    flatpickr('#due-date', { dateFormat: 'Y-m-d' });
    flatpickr('#payment-date', { dateFormat: 'Y-m-d' });
  });
</script>
{% endblock %}

