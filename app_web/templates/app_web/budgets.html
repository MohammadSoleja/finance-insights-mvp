{% extends "base.html" %}
{% load static humanize %}
{% block title %}{{ title|default:"Budgets" }} — Finance Insights{% endblock %}

{% block head_extra %}
<!-- Flatpickr for date pickers -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<style>
  .budgets-container { max-width: 1200px; margin: 0 auto; }
  .budget-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }

  /* Filter section */
  .budget-filters {
    background: #fff;
    border: 1px solid rgba(16,24,40,0.06);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1.5rem;
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    align-items: center;
  }
  .budget-filters .field-group {
    margin: 0;
    flex: 0 0 auto;
  }
  .budget-filters label {
    font-size: 0.875rem;
    font-weight: 500;
    color: #6b7280;
    margin-bottom: 0.25rem;
  }
  .budget-filters .form-select {
    min-width: 150px;
  }
  .budget-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
  .budget-card {
    background: #fff;
    border: 1px solid rgba(16,24,40,0.06);
    border-radius: 8px;
    padding: 1rem;
    box-shadow: 0 6px 12px rgba(16,24,40,0.06);
    will-change: transform, box-shadow;
    transform: translateZ(0); /* Force GPU acceleration for immediate rendering */
    backface-visibility: hidden;
    contain: layout style paint;
  }
  .budget-card:hover {
    box-shadow: 0 10px 24px rgba(16,24,40,0.08);
    transform: translateY(-2px) translateZ(0);
    transition: all 0.2s;
  }
  .budget-card.over-budget { border-left: 4px solid #ef4444; }
  .budget-card.warning { border-left: 4px solid #f59e0b; }
  .budget-card.ok { border-left: 4px solid #16a34a; }

  .budget-card-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem; }
  .budget-category { font-size: 1.1rem; font-weight: 700; color: #111827; }
  .budget-period { font-size: 0.875rem; color: #6b7280; }

  .budget-progress { margin: 1rem 0; }
  .progress-bar-container { width: 100%; height: 12px; background: #e5e7eb; border-radius: 6px; overflow: hidden; margin-bottom: 0.5rem; }
  .progress-bar { height: 100%; transition: width 0.3s; }
  .progress-bar.ok { background: #16a34a; }
  .progress-bar.warning { background: #f59e0b; }
  .progress-bar.over { background: #ef4444; }

  .budget-amounts { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.875rem; }
  .budget-amount { display: flex; flex-direction: column; }
  .budget-amount .label { color: #6b7280; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; }
  .budget-amount .value { font-weight: 700; color: #111827; font-size: 1rem; }
  .budget-amount .value.over { color: #ef4444; }
  .budget-amount .value.ok { color: #16a34a; }

  .budget-actions { margin-top: 0.75rem; display: flex; gap: 0.5rem; }
  .budget-actions .btn { font-size: 0.875rem; padding: 0.4rem 0.8rem; }

  .budget-form-section { background: #fff; border: 1px solid rgba(16,24,40,0.06); border-radius: 8px; padding: 1.5rem; margin-bottom: 2rem; }
  .budget-form-section h2 { margin-top: 0; margin-bottom: 1rem; }

  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem; }

  /* Date range fields - hide by default, show when custom period selected */
  .date-range-fields { display: none; }
  .date-range-fields.visible { display: flex; gap: 1rem; }

  /* GitHub-style label selector */
  .label-selector { display: none; } /* Hide original multi-select */
  .label-pills-container {
    border: 1px solid #d1d5db;
    border-radius: 6px;
    padding: 0.75rem;
    min-height: 100px;
    max-height: 250px;
    overflow-y: auto;
    background: #fff;
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    align-content: flex-start;
  }
  .label-pills-container.empty::before {
    content: 'Click labels to select...';
    color: #9ca3af;
    font-size: 0.875rem;
  }
  .label-pill {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.4rem 0.9rem;
    border-radius: 16px;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.15s;
    border: 1px solid #d1d5db;
    background: #f9fafb;
    color: #374151;
    user-select: none;
  }
  .label-pill:hover {
    background: #e5e7eb;
    border-color: #9ca3af;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }
  .label-pill.selected {
    background: #2563eb;
    color: white;
    border-color: #1d4ed8;
    font-weight: 500;
  }
  .label-pill.selected:hover {
    background: #1d4ed8;
  }

  /* Single row layout for name, amount, period */
  .form-row-single {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  @media (max-width: 768px) {
    .form-row { grid-template-columns: 1fr; }
    .budget-grid { grid-template-columns: 1fr; }
    .form-grid-labels-period { grid-template-columns: 1fr; }
  }

  .empty-state { text-align: center; padding: 3rem 1rem; color: #6b7280; }
  .empty-state h3 { color: #111827; margin-bottom: 0.5rem; }

  /* Modal styles for edit/delete */
  .modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
  }
  .modal-overlay.active {
    display: flex;
  }
  .modal-content {
    background: white;
    border-radius: 8px;
    padding: 1.5rem;
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
  }
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }
  .modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #6b7280;
  }
  .modal-close:hover {
    color: #111827;
  }
</style>
{% endblock %}

{% block content %}
<div class="budgets-container">
  <div class="budget-header">
    <h1>Budget Management</h1>
    <div style="display: flex; gap: 0.5rem; align-items: center;">
      <button id="bulk-delete-btn" class="btn" style="background: #ef4444; color: white; display: none;" onclick="confirmBulkDelete()">
        Delete Selected (<span id="selected-count">0</span>)
      </button>
      <button class="btn btn-primary" onclick="openAddBudgetModal()">+ Add Budget</button>
      <a href="{% url 'app_web:dashboard' %}" class="btn">← Back to Dashboard</a>
    </div>
  </div>

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }}">{{ message }}</div>
    {% endfor %}
  {% endif %}

  <!-- Budget Filters -->
  <div class="budget-filters">
    <div class="field-group">
      <label>Status</label>
      <select class="form-select" id="filter-status">
        <option value="all">All Budgets</option>
        <option value="active">Active Only</option>
        <option value="inactive">Inactive Only</option>
      </select>
    </div>

    <div class="field-group">
      <label>Period</label>
      <select class="form-select" id="filter-period">
        <option value="all">All Periods</option>
        <option value="weekly">Weekly</option>
        <option value="monthly">Monthly</option>
        <option value="yearly">Yearly</option>
        <option value="custom">Custom</option>
      </select>
    </div>

    <div class="field-group">
      <label>Usage</label>
      <select class="form-select" id="filter-usage">
        <option value="all">All</option>
        <option value="over">Over Budget</option>
        <option value="warning">Near Limit (80%+)</option>
        <option value="ok">Under 80%</option>
      </select>
    </div>

    <div class="field-group">
      <label>Sort By</label>
      <select class="form-select" id="filter-sort">
        <option value="usage">Usage (High to Low)</option>
        <option value="name">Name (A-Z)</option>
        <option value="amount">Amount (High to Low)</option>
      </select>
    </div>
  </div>

  <!-- Hidden form for backwards compatibility with edit mode -->
  <div class="budget-form-section" style="display: none;" id="inline-edit-form">
    <h2>Edit Budget</h2>
    <form method="post" action="{% url 'app_web:budgets' %}" id="edit-form">
      {% csrf_token %}
      <input type="hidden" name="action" value="{% if edit_budget %}edit{% else %}create{% endif %}">
      {% if edit_budget %}
        <input type="hidden" name="budget_id" value="{{ edit_budget.id }}">
      {% endif %}

      <!-- Single row: Name, Amount, Period -->
      <div class="form-row-single">
        <div class="field-group">
          <label for="id_name">Budget Name</label>
          {{ form.name }}
          {% if form.name.errors %}
            <div class="error-text">{{ form.name.errors }}</div>
          {% endif %}
        </div>

        <div class="field-group">
          <label for="id_amount">Budget Amount (£)</label>
          {{ form.amount }}
          {% if form.amount.errors %}
            <div class="error-text">{{ form.amount.errors }}</div>
          {% endif %}
        </div>

        <div class="field-group">
          <label for="id_period">Period Type</label>
          {{ form.period }}
          {% if form.period.errors %}
            <div class="error-text">{{ form.period.errors }}</div>
          {% endif %}
        </div>
      </div>

      <!-- Labels - all in one box, click to select -->
      <div class="field-group">
        <label for="id_labels">Track Labels (click to select)</label>

        <!-- Hidden multi-select (for form submission) -->
        <div style="display: none;">
          {{ form.labels }}
        </div>

        <!-- All labels in one container - click to toggle selection -->
        <div class="label-pills-container {% if not edit_budget %}empty{% endif %}" id="labels-container">
          <!-- Will be populated by JavaScript with all labels, selected ones are blue -->
        </div>

        {% if form.labels.errors %}
          <div class="error-text">{{ form.labels.errors }}</div>
        {% endif %}
        <small class="muted">Click labels to select (blue = selected)</small>
      </div>

      <!-- Custom Date Range Fields (shown only when period='custom') -->
      <div class="date-range-fields {% if edit_budget and edit_budget.period == 'custom' %}visible{% endif %}" id="date-range-fields">
        <div class="field-group">
          <label for="id_start_date">Start Date</label>
          {{ form.start_date }}
          {% if form.start_date.errors %}
            <div class="error-text">{{ form.start_date.errors }}</div>
          {% endif %}
        </div>

        <div class="field-group">
          <label for="id_end_date">End Date</label>
          {{ form.end_date }}
          {% if form.end_date.errors %}
            <div class="error-text">{{ form.end_date.errors }}</div>
          {% endif %}
        </div>
      </div>

      <div class="field-group" style="margin-top: 1rem;">
        <label for="id_active" style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
          {{ form.active }}
          <span>Active</span>
        </label>
        {% if form.active.errors %}
          <div class="error-text">{{ form.active.errors }}</div>
        {% endif %}
      </div>

      <div class="toolbar-actions">
        <button type="submit" class="btn btn-primary">
          {% if edit_budget %}Update Budget{% else %}Create Budget{% endif %}
        </button>
        {% if edit_budget %}
          <a href="{% url 'app_web:budgets' %}" class="btn">Cancel</a>
        {% endif %}
      </div>
    </form>
  </div>

  <!-- Budget List -->
  <h2>Your Budgets</h2>

  {% if budget_summary %}
    <div class="budget-grid" id="budget-grid">
      {% for budget in budget_summary %}
        <div class="budget-card {% if budget.is_over %}over-budget{% elif budget.percent_used >= 80 %}warning{% else %}ok{% endif %}"
             data-budget-id="{{ budget.id }}"
             data-period="{{ budget.period_value }}"
             data-amount="{{ budget.budget_amount }}"
             data-usage="{{ budget.percent_used }}"
             {% if not budget.active|default:True %}data-inactive="true"{% endif %}>
          <div class="budget-card-header">
            <div style="display: flex; align-items: start; gap: 0.5rem; flex: 1;">
              <input type="checkbox" class="budget-checkbox" data-budget-id="{{ budget.id }}" style="margin-top: 0.25rem; cursor: pointer;">
              <div style="flex: 1;">
                <div class="budget-category">{{ budget.name }}</div>
                <div class="budget-period">{{ budget.period }}</div>
                {% if budget.labels %}
                  <div class="budget-labels" style="margin-top: 0.25rem; font-size: 0.75rem; color: #6b7280;">
                    Labels: {% for label in budget.labels %}{{ label }}{% if not forloop.last %}, {% endif %}{% endfor %}
                  </div>
                {% endif %}
              </div>
            </div>
          </div>

          <div class="budget-progress">
            <div class="progress-bar-container">
              <div class="progress-bar {% if budget.is_over %}over{% elif budget.percent_used >= 80 %}warning{% else %}ok{% endif %}"
                   style="width: {% if budget.percent_used > 100 %}100{% else %}{{ budget.percent_used }}{% endif %}%"></div>
            </div>
            <div class="budget-percent" style="text-align: center; font-weight: 700; color: {% if budget.is_over %}#ef4444{% elif budget.percent_used >= 80 %}#f59e0b{% else %}#16a34a{% endif %};">
              {{ budget.percent_used }}% used
            </div>
          </div>

          <div class="budget-amounts">
            <div class="budget-amount">
              <span class="label">Spent</span>
              <span class="value budget-spent {% if budget.is_over %}over{% endif %}">£{{ budget.spent|floatformat:2|intcomma }}</span>
            </div>
            <div class="budget-amount">
              <span class="label">Remaining</span>
              <span class="value budget-remaining {% if budget.remaining >= 0 %}ok{% else %}over{% endif %}">£{{ budget.remaining|floatformat:2|intcomma }}</span>
            </div>
            <div class="budget-amount">
              <span class="label">Budget</span>
              <span class="value budget-total">£{{ budget.budget_amount|floatformat:2|intcomma }}</span>
            </div>
            <div class="budget-amount">
              <span class="label">Period</span>
              <span class="value budget-period-dates" style="font-size: 0.875rem;">{{ budget.period }}</span>
            </div>
          </div>

          <div class="budget-actions">
            <button class="btn btn-sm" onclick="openEditModal({{ budget.id }})">Edit</button>
            <button class="btn btn-sm" onclick="confirmDelete({{ budget.id }}, '{{ budget.name|escapejs }}')" style="background: #ef4444; color: white;">Delete</button>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="empty-state" id="empty-state">
      <h3>No budgets yet</h3>
      <p>Create your first budget to start tracking your spending limits.</p>
    </div>
  {% endif %}
</div>

<!-- Add Budget Modal -->
<div class="modal-overlay" id="addBudgetModal">
  <div class="modal-content" style="max-width: 600px;">
    <div class="modal-header">
      <h3>Add Budget</h3>
      <button class="modal-close" onclick="closeAddBudgetModal()">×</button>
    </div>
    <form method="post" action="{% url 'app_web:budgets' %}" id="add-budget-form">
      {% csrf_token %}
      <input type="hidden" name="action" value="create">

      <!-- Single row: Name, Amount, Period -->
      <div class="form-row-single">
        <div class="field-group">
          <label for="modal_name">Budget Name</label>
          <input type="text" name="name" id="modal_name" class="form-input" placeholder="Q4 Marketing" required>
        </div>

        <div class="field-group">
          <label for="modal_amount">Amount (£)</label>
          <input type="number" name="amount" id="modal_amount" class="form-input" placeholder="5000" step="0.01" min="0" required>
        </div>

        <div class="field-group">
          <label for="modal_period">Period</label>
          <select name="period" id="modal_period" class="form-select">
            <option value="monthly">Monthly</option>
            <option value="weekly">Weekly</option>
            <option value="yearly">Yearly</option>
            <option value="custom">Custom Date Range</option>
          </select>
        </div>
      </div>

      <!-- Labels -->
      <div class="field-group">
        <label>Track Labels (click to select)</label>
        <div class="label-pills-container empty" id="modal-labels-container">
          <!-- Populated by JavaScript -->
        </div>
        <small class="muted">Click labels to select (blue = selected)</small>
      </div>

      <!-- Custom Date Range -->
      <div class="date-range-fields" id="modal-date-range-fields">
        <div class="field-group">
          <label for="modal_start_date">Start Date</label>
          <input type="text" name="start_date" id="modal_start_date" class="form-input form-date" placeholder="Start date">
        </div>
        <div class="field-group">
          <label for="modal_end_date">End Date</label>
          <input type="text" name="end_date" id="modal_end_date" class="form-input form-date" placeholder="End date">
        </div>
      </div>

      <div class="field-group" style="margin-top: 1rem;">
        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
          <input type="checkbox" name="active" checked class="form-checkbox">
          <span>Active</span>
        </label>
      </div>

      <!-- Recurring Budget Options -->
      <div class="field-group" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
          <input type="checkbox" id="modal_is_recurring" name="is_recurring" class="form-checkbox" value="true">
          <span style="font-weight: 500;">Make this recurring</span>
        </label>
      </div>

      <div id="modal-recurring-options" style="display: none; margin-top: 0.75rem; padding: 0.75rem; background: #f9fafb; border-radius: 6px;">
        <div class="field-group" style="margin-bottom: 0;">
          <label for="modal_recurrence_count">Number of periods to create</label>
          <input type="number" name="recurrence_count" id="modal_recurrence_count" class="form-input" min="1" max="12" placeholder="3" style="max-width: 120px;">
          <small class="muted" style="display: block; margin-top: 0.25rem;">
            Creates budgets for the current period plus this many future periods.<br>
            Example: For monthly with 3, creates budgets for this month + next 3 months (4 total).
          </small>
        </div>
      </div>

      <div class="toolbar-actions" style="margin-top: 1.5rem;">
        <button type="submit" class="btn btn-primary" id="modal-submit-btn">Create Budget</button>
        <button type="button" class="btn" onclick="closeAddBudgetModal()">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Edit Budget Modal -->
<div class="modal-overlay" id="editModal">
  <div class="modal-content" style="max-width: 600px;">
    <div class="modal-header">
      <h3>Edit Budget</h3>
      <button class="modal-close" onclick="closeEditModal()">×</button>
    </div>
    <form method="post" action="{% url 'app_web:budgets' %}" id="edit-budget-form">
      {% csrf_token %}
      <input type="hidden" name="action" value="edit">
      <input type="hidden" name="budget_id" id="edit_budget_id">

      <!-- Single row: Name, Amount, Period -->
      <div class="form-row-single">
        <div class="field-group">
          <label for="edit_name">Budget Name</label>
          <input type="text" name="name" id="edit_name" class="form-input" placeholder="Q4 Marketing" required>
        </div>

        <div class="field-group">
          <label for="edit_amount">Amount (£)</label>
          <input type="number" name="amount" id="edit_amount" class="form-input" placeholder="5000" step="0.01" min="0" required>
        </div>

        <div class="field-group">
          <label for="edit_period">Period</label>
          <select name="period" id="edit_period" class="form-select">
            <option value="monthly">Monthly</option>
            <option value="weekly">Weekly</option>
            <option value="yearly">Yearly</option>
            <option value="custom">Custom Date Range</option>
          </select>
        </div>
      </div>

      <!-- Labels -->
      <div class="field-group">
        <label>Track Labels (click to select)</label>
        <div class="label-pills-container" id="edit-labels-container">
          <!-- Populated by JavaScript -->
        </div>
        <small class="muted">Click labels to select (blue = selected)</small>
      </div>

      <!-- Custom Date Range -->
      <div class="date-range-fields" id="edit-date-range-fields">
        <div class="field-group">
          <label for="edit_start_date">Start Date</label>
          <input type="text" name="start_date" id="edit_start_date" class="form-input form-date" placeholder="Start date">
        </div>
        <div class="field-group">
          <label for="edit_end_date">End Date</label>
          <input type="text" name="end_date" id="edit_end_date" class="form-input form-date" placeholder="End date">
        </div>
      </div>

      <div class="field-group" style="margin-top: 1rem;">
        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
          <input type="checkbox" name="active" id="edit_active" class="form-checkbox">
          <span>Active</span>
        </label>
      </div>

      <!-- Recurring Budget Edit Options -->
      <div id="edit-recurring-options" style="display: none; margin-top: 1rem; padding: 1rem; background: #f9fafb; border-radius: 6px;">
        <input type="hidden" name="recurring_group_id" id="edit_recurring_group_id">
        <div class="field-group" style="margin-bottom: 0;">
          <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Apply changes to:</label>
          <div style="display: flex; flex-direction: column; gap: 0.5rem;">
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
              <input type="radio" name="edit_scope" value="this" checked class="form-radio">
              <span>This budget only</span>
            </label>
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
              <input type="radio" name="edit_scope" value="future" class="form-radio">
              <span>This and all future budgets in this series</span>
            </label>
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
              <input type="radio" name="edit_scope" value="all" class="form-radio">
              <span>All budgets in this series (past and future)</span>
            </label>
          </div>
          <small class="muted" style="display: block; margin-top: 0.5rem;">
            This budget is part of a recurring series. Choose how broadly to apply your changes.
          </small>
        </div>
      </div>

      <div class="toolbar-actions" style="margin-top: 1.5rem;">
        <button type="submit" class="btn btn-primary">Update Budget</button>
        <button type="button" class="btn" onclick="closeEditModal()">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal-overlay" id="deleteModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="deleteModalTitle">Delete Budget</h3>
      <button class="modal-close" onclick="closeDeleteModal()">×</button>
    </div>
    <div id="deleteSingleContent">
      <p>Are you sure you want to delete budget "<strong id="deleteBudgetName"></strong>"?</p>
      <p class="muted" style="font-size: 0.875rem;">This action cannot be undone.</p>
    </div>
    <div id="deleteBulkContent" style="display: none;">
      <p>Are you sure you want to delete <strong id="deleteBulkCount">0</strong> budgets?</p>
      <p class="muted" style="font-size: 0.875rem;">This action cannot be undone.</p>
    </div>
    <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
      <button class="btn" onclick="closeDeleteModal()">Cancel</button>
      <button class="btn" style="background: #ef4444; color: white;" onclick="deleteBudget()">
        <span id="deleteButtonText">Delete Budget</span>
      </button>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<!-- Flatpickr for date pickers -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
(function() {
  'use strict';

  // Make budget data available to JavaScript
  window.budgetSummaryData = {{ budget_summary_json|safe }};

  // New label selector - all labels in box, click to toggle selection
  function initLabelSelector(containerId, hiddenSelectId) {
    const container = document.getElementById(containerId);
    const hiddenSelect = document.getElementById(hiddenSelectId);

    if (!container || !hiddenSelect) return;

    // Get all available labels
    const allLabels = Array.from(hiddenSelect.options).map(opt => ({
      id: opt.value,
      name: opt.text
    })).filter(l => l.id);

    // Get pre-selected label IDs
    const preSelected = Array.from(hiddenSelect.options)
      .filter(opt => opt.selected)
      .map(opt => opt.value);

    // Render all labels
    function renderLabels() {
      container.innerHTML = '';
      if (allLabels.length === 0) {
        container.classList.add('empty');
        return;
      }
      container.classList.remove('empty');

      allLabels.forEach(label => {
        const pill = document.createElement('span');
        pill.className = 'label-pill';
        pill.textContent = label.name;
        pill.dataset.labelId = label.id;

        // Check if pre-selected
        if (preSelected.includes(label.id)) {
          pill.classList.add('selected');
        }

        pill.onclick = () => toggleLabel(label.id);
        container.appendChild(pill);
      });
    }

    // Toggle label selection
    function toggleLabel(id) {
      const pill = container.querySelector(`[data-label-id="${id}"]`);
      if (!pill) return;

      pill.classList.toggle('selected');

      // Update hidden select
      Array.from(hiddenSelect.options).forEach(opt => {
        if (opt.value === id) {
          opt.selected = pill.classList.contains('selected');
        }
      });
    }

    renderLabels();
  }

  // Initialize label selectors
  if (document.getElementById('labels-container')) {
    initLabelSelector('labels-container', 'id_labels');
  }
  if (document.getElementById('modal-labels-container')) {
    initLabelSelector('modal-labels-container', 'modal_labels');
  }

  // Modal functions
  let currentDeleteId = null;
  let currentDeleteIds = []; // For bulk delete

  window.openAddBudgetModal = function() {
    // Populate modal with labels
    const form = document.getElementById('add-budget-form');

    // Create hidden select for labels in modal
    const hiddenSelect = document.createElement('select');
    hiddenSelect.id = 'modal_labels';
    hiddenSelect.name = 'labels';
    hiddenSelect.multiple = true;
    hiddenSelect.style.display = 'none';

    // Copy options from main form
    const mainSelect = document.getElementById('id_labels');
    if (mainSelect) {
      Array.from(mainSelect.options).forEach(opt => {
        if (opt.value) {
          const newOpt = document.createElement('option');
          newOpt.value = opt.value;
          newOpt.text = opt.text;
          hiddenSelect.appendChild(newOpt);
        }
      });
    }
    form.appendChild(hiddenSelect);

    // Initialize label selector for modal
    initLabelSelector('modal-labels-container', 'modal_labels');

    // Initialize modal date pickers
    flatpickr('#modal_start_date', { dateFormat: 'Y-m-d', altInput: true, altFormat: 'M j, Y' });
    flatpickr('#modal_end_date', { dateFormat: 'Y-m-d', altInput: true, altFormat: 'M j, Y' });

    document.getElementById('addBudgetModal').classList.add('active');
  };

  window.closeAddBudgetModal = function() {
    document.getElementById('addBudgetModal').classList.remove('active');
  };

  window.openEditModal = async function(budgetId) {
    // Find the budget card to get data
    const card = document.querySelector(`[data-budget-id="${budgetId}"]`);
    if (!card) return;

    // Get budget data from card
    const name = card.querySelector('.budget-category').textContent.trim();
    const period = card.dataset.period;
    const amount = card.dataset.amount;

    // Populate form
    document.getElementById('edit_budget_id').value = budgetId;
    document.getElementById('edit_name').value = name;
    document.getElementById('edit_amount').value = amount;
    document.getElementById('edit_period').value = period;

    // Get labels from budget summary data
    const budgetData = window.budgetSummaryData || [];
    const budget = budgetData.find(b => b.id == budgetId);

    // Create hidden select for labels in edit modal
    let hiddenSelect = document.getElementById('edit_labels');
    if (!hiddenSelect) {
      hiddenSelect = document.createElement('select');
      hiddenSelect.id = 'edit_labels';
      hiddenSelect.name = 'labels';
      hiddenSelect.multiple = true;
      hiddenSelect.style.display = 'none';
      document.getElementById('edit-budget-form').appendChild(hiddenSelect);

      // Copy options from main form
      const mainSelect = document.getElementById('id_labels');
      if (mainSelect) {
        Array.from(mainSelect.options).forEach(opt => {
          if (opt.value) {
            const newOpt = document.createElement('option');
            newOpt.value = opt.value;
            newOpt.text = opt.text;
            hiddenSelect.appendChild(newOpt);
          }
        });
      }
    }

    // Initialize label selector for edit modal
    initLabelSelector('edit-labels-container', 'edit_labels');

    // Pre-select budget labels
    if (budget && budget.labels) {
      budget.labels.forEach(labelName => {
        const pill = document.querySelector(`#edit-labels-container [data-label-id]`);
        // Find and select matching labels
        const allPills = document.querySelectorAll('#edit-labels-container .label-pill');
        allPills.forEach(p => {
          if (p.textContent.trim() === labelName) {
            p.classList.add('selected');
            // Update hidden select
            Array.from(hiddenSelect.options).forEach(opt => {
              if (opt.text === labelName) {
                opt.selected = true;
              }
            });
          }
        });
      });
    }

    // Handle custom dates
    if (period === 'custom') {
      document.getElementById('edit-date-range-fields').classList.add('visible');
      // Get dates from card if available
      const dateSpan = card.querySelector('.budget-period-dates');
      if (dateSpan) {
        // Parse dates from card (you may need to adjust based on format)
        const dateText = dateSpan.textContent;
        // For now, leave empty - user can set new dates
      }
    } else {
      document.getElementById('edit-date-range-fields').classList.remove('visible');
    }

    // Set active checkbox
    const isActive = !card.dataset.inactive;
    document.getElementById('edit_active').checked = isActive;

    // Check if this budget is part of a recurring group
    const recurringOptions = document.getElementById('edit-recurring-options');
    if (budget && budget.recurring_group_id) {
      // Show recurring edit options
      document.getElementById('edit_recurring_group_id').value = budget.recurring_group_id;
      recurringOptions.style.display = 'block';
      // Reset radio to "this" option
      document.querySelector('input[name="edit_scope"][value="this"]').checked = true;
    } else {
      // Hide recurring options
      recurringOptions.style.display = 'none';
    }

    // Initialize edit modal date pickers
    if (!document.getElementById('edit_start_date')._flatpickr) {
      flatpickr('#edit_start_date', { dateFormat: 'Y-m-d', altInput: true, altFormat: 'M j, Y' });
      flatpickr('#edit_end_date', { dateFormat: 'Y-m-d', altInput: true, altFormat: 'M j, Y' });
    }

    // Show modal
    document.getElementById('editModal').classList.add('active');
  };

  window.closeEditModal = function() {
    document.getElementById('editModal').classList.remove('active');
  };

  // Edit modal period change handler
  const editPeriod = document.getElementById('edit_period');
  const editDateFields = document.getElementById('edit-date-range-fields');
  if (editPeriod && editDateFields) {
    editPeriod.addEventListener('change', function() {
      if (this.value === 'custom') {
        editDateFields.classList.add('visible');
      } else {
        editDateFields.classList.remove('visible');
      }
    });
  }

  window.confirmDelete = function(budgetId, budgetName) {
    currentDeleteId = budgetId;
    currentDeleteIds = []; // Clear bulk delete IDs

    // Update modal for single delete
    document.getElementById('deleteModalTitle').textContent = 'Delete Budget';
    document.getElementById('deleteSingleContent').style.display = 'block';
    document.getElementById('deleteBulkContent').style.display = 'none';
    document.getElementById('deleteBudgetName').textContent = budgetName;
    document.getElementById('deleteButtonText').textContent = 'Delete Budget';

    document.getElementById('deleteModal').classList.add('active');
  };

  window.closeDeleteModal = function() {
    document.getElementById('deleteModal').classList.remove('active');
    currentDeleteId = null;
    currentDeleteIds = [];
  };


  window.deleteBudget = function() {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '';

    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = document.querySelector('[name=csrfmiddlewaretoken]').value;

    const actionInput = document.createElement('input');
    actionInput.type = 'hidden';
    actionInput.name = 'action';

    // Check if bulk delete or single delete
    if (currentDeleteIds.length > 0) {
      actionInput.value = 'bulk_delete';
      const idsInput = document.createElement('input');
      idsInput.type = 'hidden';
      idsInput.name = 'budget_ids';
      idsInput.value = currentDeleteIds.join(',');
      form.appendChild(idsInput);
    } else if (currentDeleteId) {
      actionInput.value = 'delete';
      const idInput = document.createElement('input');
      idInput.type = 'hidden';
      idInput.name = 'budget_id';
      idInput.value = currentDeleteId;
      form.appendChild(idInput);
    } else {
      return; // Nothing to delete
    }

    form.appendChild(csrfInput);
    form.appendChild(actionInput);
    document.body.appendChild(form);
    form.submit();
  };

  // Bulk delete confirmation
  window.confirmBulkDelete = function() {
    const checkboxes = document.querySelectorAll('.budget-checkbox:checked');
    if (checkboxes.length === 0) return;

    currentDeleteIds = Array.from(checkboxes).map(cb => cb.dataset.budgetId);
    currentDeleteId = null; // Clear single delete ID

    // Update modal for bulk delete
    document.getElementById('deleteModalTitle').textContent = 'Delete Multiple Budgets';
    document.getElementById('deleteSingleContent').style.display = 'none';
    document.getElementById('deleteBulkContent').style.display = 'block';
    document.getElementById('deleteBulkCount').textContent = currentDeleteIds.length;
    document.getElementById('deleteButtonText').textContent = 'Delete Budgets';

    document.getElementById('deleteModal').classList.add('active');
  };

  // Handle checkbox selection
  function updateBulkDeleteButton() {
    const checkboxes = document.querySelectorAll('.budget-checkbox:checked');
    const count = checkboxes.length;
    const bulkDeleteBtn = document.getElementById('bulk-delete-btn');
    const selectedCount = document.getElementById('selected-count');

    if (count > 0) {
      bulkDeleteBtn.style.display = 'block';
      selectedCount.textContent = count;
    } else {
      bulkDeleteBtn.style.display = 'none';
    }
  }

  // Attach checkbox listeners
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.budget-checkbox').forEach(checkbox => {
      checkbox.addEventListener('change', updateBulkDeleteButton);
    });
  });


  // Budget filtering
  function filterBudgets() {
    const statusFilter = document.getElementById('filter-status').value;
    const periodFilter = document.getElementById('filter-period').value;
    const usageFilter = document.getElementById('filter-usage').value;
    const sortFilter = document.getElementById('filter-sort').value;

    const cards = Array.from(document.querySelectorAll('.budget-card'));

    // Filter cards
    cards.forEach(card => {
      let show = true;

      // Status filter
      if (statusFilter === 'active') {
        show = show && !card.dataset.inactive;
      } else if (statusFilter === 'inactive') {
        show = show && card.dataset.inactive;
      }

      // Period filter
      if (periodFilter !== 'all') {
        show = show && card.dataset.period === periodFilter;
      }

      // Usage filter
      if (usageFilter === 'over') {
        show = show && card.classList.contains('over-budget');
      } else if (usageFilter === 'warning') {
        show = show && card.classList.contains('warning');
      } else if (usageFilter === 'ok') {
        show = show && card.classList.contains('ok');
      }

      card.style.display = show ? '' : 'none';
    });

    // Sort cards
    const grid = document.getElementById('budget-grid');
    if (!grid) return;

    const visibleCards = cards.filter(c => c.style.display !== 'none');
    visibleCards.sort((a, b) => {
      if (sortFilter === 'name') {
        const nameA = a.querySelector('.budget-category').textContent;
        const nameB = b.querySelector('.budget-category').textContent;
        return nameA.localeCompare(nameB);
      } else if (sortFilter === 'amount') {
        const amountA = parseFloat(a.dataset.amount || 0);
        const amountB = parseFloat(b.dataset.amount || 0);
        return amountB - amountA;
      } else { // usage
        const usageA = parseFloat(a.dataset.usage || 0);
        const usageB = parseFloat(b.dataset.usage || 0);
        return usageB - usageA;
      }
    });

    visibleCards.forEach(card => grid.appendChild(card));
  }

  // Attach filter listeners
  ['filter-status', 'filter-period', 'filter-usage', 'filter-sort'].forEach(id => {
    const elem = document.getElementById(id);
    if (elem) elem.addEventListener('change', filterBudgets);
  });

  // Close modals on outside click
  document.querySelectorAll('.modal-overlay').forEach(overlay => {
    overlay.addEventListener('click', function(e) {
      if (e.target === this) {
        this.classList.remove('active');
      }
    });
  });

  // Modal period change handler
  const modalPeriod = document.getElementById('modal_period');
  const modalDateFields = document.getElementById('modal-date-range-fields');
  const modalRecurringCheckbox = document.getElementById('modal_is_recurring');
  const modalRecurringOptions = document.getElementById('modal-recurring-options');
  const modalSubmitBtn = document.getElementById('modal-submit-btn');

  if (modalPeriod && modalDateFields) {
    modalPeriod.addEventListener('change', function() {
      if (this.value === 'custom') {
        modalDateFields.classList.add('visible');
        // Disable recurring for custom periods
        if (modalRecurringCheckbox) {
          modalRecurringCheckbox.checked = false;
          modalRecurringCheckbox.disabled = true;
          if (modalRecurringOptions) modalRecurringOptions.style.display = 'none';
        }
      } else {
        modalDateFields.classList.remove('visible');
        // Re-enable recurring
        if (modalRecurringCheckbox) {
          modalRecurringCheckbox.disabled = false;
        }
      }
    });
  }

  // Handle recurring checkbox toggle
  if (modalRecurringCheckbox && modalRecurringOptions) {
    modalRecurringCheckbox.addEventListener('change', function() {
      if (this.checked) {
        modalRecurringOptions.style.display = 'block';
        if (modalSubmitBtn) modalSubmitBtn.textContent = 'Create Recurring Budget';
      } else {
        modalRecurringOptions.style.display = 'none';
        if (modalSubmitBtn) modalSubmitBtn.textContent = 'Create Budget';
      }
    });
  }

  // Initialize Flatpickr on date inputs
  const startDateInput = document.getElementById('id_start_date');
  const endDateInput = document.getElementById('id_end_date');

  if (startDateInput) {
    flatpickr(startDateInput, {
      dateFormat: 'Y-m-d',
      altInput: true,
      altFormat: 'M j, Y',
      onChange: function(selectedDates) {
        if (selectedDates[0] && endDateInput._flatpickr) {
          endDateInput._flatpickr.set('minDate', selectedDates[0]);
        }
      }
    });
  }

  if (endDateInput) {
    flatpickr(endDateInput, {
      dateFormat: 'Y-m-d',
      altInput: true,
      altFormat: 'M j, Y'
    });
  }

  // Show/hide date range fields based on period selection
  const periodSelect = document.getElementById('id_period');
  const dateRangeFields = document.getElementById('date-range-fields');

  if (periodSelect && dateRangeFields) {
    function toggleDateFields() {
      if (periodSelect.value === 'custom') {
        dateRangeFields.classList.add('visible');
        if (startDateInput) startDateInput.required = true;
        if (endDateInput) endDateInput.required = true;
      } else {
        dateRangeFields.classList.remove('visible');
        if (startDateInput) startDateInput.required = false;
        if (endDateInput) endDateInput.required = false;
      }
    }

    toggleDateFields();
    periodSelect.addEventListener('change', toggleDateFields);
  }

  // ...existing auto-refresh code...
  function formatMoney(num) {
    return new Intl.NumberFormat('en-GB', {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    }).format(num);
  }

  // Update a single budget card with new data
  function updateBudgetCard(card, budgetData) {
    if (!card) return;

    // Update status class (over-budget, warning, ok)
    card.classList.remove('over-budget', 'warning', 'ok');
    if (budgetData.is_over) {
      card.classList.add('over-budget');
    } else if (budgetData.percent_used >= 80) {
      card.classList.add('warning');
    } else {
      card.classList.add('ok');
    }

    // Update progress bar
    const progressBar = card.querySelector('.progress-bar');
    if (progressBar) {
      const width = budgetData.percent_used > 100 ? 100 : budgetData.percent_used;
      progressBar.style.width = width + '%';
      progressBar.classList.remove('over', 'warning', 'ok');
      if (budgetData.is_over) {
        progressBar.classList.add('over');
      } else if (budgetData.percent_used >= 80) {
        progressBar.classList.add('warning');
      } else {
        progressBar.classList.add('ok');
      }
    }

    // Update percentage text with color
    const percentElem = card.querySelector('.budget-percent');
    if (percentElem) {
      percentElem.textContent = budgetData.percent_used + '% used';
      let color = '#16a34a'; // green (ok)
      if (budgetData.is_over) {
        color = '#ef4444'; // red (over)
      } else if (budgetData.percent_used >= 80) {
        color = '#f59e0b'; // orange (warning)
      }
      percentElem.style.color = color;
    }

    // Update spent amount
    const spentElem = card.querySelector('.budget-spent');
    if (spentElem) {
      spentElem.textContent = '£' + formatMoney(budgetData.spent);
      spentElem.classList.toggle('over', budgetData.is_over);
    }

    // Update remaining amount
    const remainingElem = card.querySelector('.budget-remaining');
    if (remainingElem) {
      remainingElem.textContent = '£' + formatMoney(budgetData.remaining);
      remainingElem.classList.remove('ok', 'over');
      remainingElem.classList.add(budgetData.remaining >= 0 ? 'ok' : 'over');
    }

    // Update budget total (in case it changed)
    const totalElem = card.querySelector('.budget-total');
    if (totalElem) {
      totalElem.textContent = '£' + formatMoney(budgetData.budget_amount);
    }

    // Add subtle pulse animation to show update
    card.style.animation = 'none';
    setTimeout(() => {
      card.style.animation = 'budget-update-pulse 0.5s ease';
    }, 10);
  }

  // Fetch and update all budgets
  function refreshBudgets() {
    fetch('/api/budget-list/')
      .then(response => response.json())
      .then(data => {
        if (data.ok && data.budgets) {
          // Update each budget card
          data.budgets.forEach(budget => {
            const card = document.querySelector(`[data-budget-id="${budget.id}"]`);
            if (card) {
              updateBudgetCard(card, budget);
            }
          });

          // Show indicator that data was refreshed
          showRefreshIndicator();
        }
      })
      .catch(error => {
        console.error('Failed to refresh budgets:', error);
      });
  }

  // Show a subtle indicator that budgets were refreshed
  function showRefreshIndicator() {
    const header = document.querySelector('.budget-header h1');
    if (!header) return;

    const indicator = document.createElement('span');
    indicator.textContent = '●';
    indicator.style.cssText = 'color: #16a34a; margin-left: 0.5rem; font-size: 0.5rem; opacity: 0; transition: opacity 0.3s;';
    header.appendChild(indicator);

    setTimeout(() => { indicator.style.opacity = '1'; }, 10);
    setTimeout(() => { indicator.style.opacity = '0'; }, 1500);
    setTimeout(() => { indicator.remove(); }, 1800);
  }

  // Auto-refresh every 30 seconds
  const refreshInterval = setInterval(refreshBudgets, 30000);

  // Clean up interval when page is hidden/closed
  document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
      clearInterval(refreshInterval);
    }
  });

  // Add CSS animation for pulse effect
  const style = document.createElement('style');
  style.textContent = `
    @keyframes budget-update-pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.01); }
      100% { transform: scale(1); }
    }
  `;
  document.head.appendChild(style);

})();
</script>
{% endblock %}
