{% extends "base.html" %}
{% load static humanize currency_tags %}
{% block title %}{{ title|default:"Budgets" }} — Finance Insights{% endblock %}

{% block head_extra %}
<!-- Flatpickr for date pickers -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<!-- Budget Styles -->
<link rel="stylesheet" href="{% static 'app_web/budgets.css' %}">
{% endblock %}

{% block content %}
<div class="budgets-container">
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }}">{{ message }}</div>
    {% endfor %}
  {% endif %}

  <!-- Standardized Toolbar -->
  <div class="page-toolbar">
    <div class="toolbar-content">
      <!-- Status Filter -->
      <div class="toolbar-select">
        <select class="form-select" id="filter-status">
          <option value="all">All Status</option>
          <option value="active">Active Only</option>
          <option value="inactive">Inactive Only</option>
        </select>
      </div>

      <!-- Period Filter -->
      <div class="toolbar-select">
        <select class="form-select" id="filter-period">
          <option value="all">All Periods</option>
          <option value="weekly">Weekly</option>
          <option value="monthly">Monthly</option>
          <option value="yearly">Yearly</option>
          <option value="custom">Custom</option>
        </select>
      </div>

      <!-- Usage Filter -->
      <div class="toolbar-select">
        <select class="form-select" id="filter-usage">
          <option value="all">All Usage</option>
          <option value="over">Over Budget</option>
          <option value="warning">Near Limit (80%+)</option>
          <option value="ok">Under 80%</option>
        </select>
      </div>

      <!-- Sort -->
      <div class="toolbar-select">
        <select class="form-select" id="filter-sort">
          <option value="usage">Sort: Usage ↓</option>
          <option value="name">Sort: Name ↑</option>
          <option value="amount">Sort: Amount ↓</option>
        </select>
      </div>

      <!-- Actions -->
      <div class="toolbar-actions">
        <button id="bulk-delete-btn" class="btn btn-secondary" style="display: none;" onclick="confirmBulkDelete()">
          Delete (<span id="selected-count">0</span>)
        </button>
        <button class="btn btn-primary" onclick="openAddBudgetModal()">+ Add Budget</button>
      </div>
    </div>
  </div>

  <!-- Hidden form for backwards compatibility with edit mode -->
  <div class="budget-form-section" style="display: none;" id="inline-edit-form">
    <h2>Edit Budget</h2>
    <form method="post" action="{% url 'app_web:budgets' %}" id="edit-form">
      {% csrf_token %}
      <input type="hidden" name="action" value="{% if edit_budget %}edit{% else %}create{% endif %}">
      {% if edit_budget %}
        <input type="hidden" name="budget_id" value="{{ edit_budget.id }}">
      {% endif %}

      <!-- Single row: Name, Amount, Period -->
      <div class="form-row-single">
        <div class="field-group">
          <label for="id_name">Budget Name</label>
          {{ form.name }}
          {% if form.name.errors %}
            <div class="error-text">{{ form.name.errors }}</div>
          {% endif %}
        </div>

        <div class="field-group">
          <label for="id_amount">Budget Amount (£)</label>
          {{ form.amount }}
          {% if form.amount.errors %}
            <div class="error-text">{{ form.amount.errors }}</div>
          {% endif %}
        </div>

        <div class="field-group">
          <label for="id_period">Period Type</label>
          {{ form.period }}
          {% if form.period.errors %}
            <div class="error-text">{{ form.period.errors }}</div>
          {% endif %}
        </div>
      </div>

      <!-- Labels - all in one box, click to select -->
      <div class="field-group">
        <label for="id_labels">Track Labels (click to select)</label>

        <!-- Hidden multi-select (for form submission) -->
        <div style="display: none;">
          {{ form.labels }}
        </div>

        <!-- All labels in one container - click to toggle selection -->
        <div class="label-pills-container {% if not edit_budget %}empty{% endif %}" id="labels-container">
          <!-- Will be populated by JavaScript with all labels, selected ones are blue -->
        </div>

        {% if form.labels.errors %}
          <div class="error-text">{{ form.labels.errors }}</div>
        {% endif %}
        <small class="muted">Click labels to select (blue = selected)</small>
      </div>

      <!-- Custom Date Range Fields (shown only when period='custom') -->
      <div class="date-range-fields {% if edit_budget and edit_budget.period == 'custom' %}visible{% endif %}" id="date-range-fields">
        <div class="field-group">
          <label for="id_start_date">Start Date</label>
          {{ form.start_date }}
          {% if form.start_date.errors %}
            <div class="error-text">{{ form.start_date.errors }}</div>
          {% endif %}
        </div>

        <div class="field-group">
          <label for="id_end_date">End Date</label>
          {{ form.end_date }}
          {% if form.end_date.errors %}
            <div class="error-text">{{ form.end_date.errors }}</div>
          {% endif %}
        </div>
      </div>

      <div class="field-group" style="margin-top: 1rem;">
        <label for="id_active" style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
          {{ form.active }}
          <span>Active</span>
        </label>
        {% if form.active.errors %}
          <div class="error-text">{{ form.active.errors }}</div>
        {% endif %}
      </div>

      <div class="toolbar-actions">
        <button type="submit" class="btn btn-primary">
          {% if edit_budget %}Update Budget{% else %}Create Budget{% endif %}
        </button>
        {% if edit_budget %}
          <a href="{% url 'app_web:budgets' %}" class="btn">Cancel</a>
        {% endif %}
      </div>
    </form>
  </div>

  <!-- Budget List -->
  <h2>Your Budgets</h2>

  {% if budget_summary %}
    <div class="budget-grid" id="budget-grid">
      {% for budget in budget_summary %}
        <div class="budget-card {% if budget.is_over %}over-budget{% elif budget.percent_used >= 80 %}warning{% else %}ok{% endif %}"
             data-budget-id="{{ budget.id }}"
             data-period="{{ budget.period_value }}"
             data-amount="{{ budget.budget_amount }}"
             data-usage="{{ budget.percent_used }}"
             {% if not budget.active|default:True %}data-inactive="true"{% endif %}>
          <div class="budget-card-header">
            <div style="display: flex; align-items: start; gap: 0.5rem; flex: 1;">
              <input type="checkbox" class="budget-checkbox" data-budget-id="{{ budget.id }}" style="margin-top: 0.25rem; cursor: pointer;">
              <div style="flex: 1;">
                <div class="budget-category">{{ budget.name }}</div>
                <div class="budget-period">{{ budget.period }}</div>
                {% if budget.labels %}
                  <div class="budget-labels" style="margin-top: 0.25rem; font-size: 0.75rem; color: #6b7280;">
                    Labels: {% for label in budget.labels %}{{ label }}{% if not forloop.last %}, {% endif %}{% endfor %}
                  </div>
                {% endif %}
              </div>
            </div>
          </div>

          <div class="budget-progress">
            <div class="progress-bar-container">
              <div class="progress-bar {% if budget.is_over %}over{% elif budget.percent_used >= 80 %}warning{% else %}ok{% endif %}"
                   style="width: {% if budget.percent_used > 100 %}100{% else %}{{ budget.percent_used }}{% endif %}%"></div>
            </div>
            <div class="budget-percent" style="text-align: center; font-weight: 700; color: {% if budget.is_over %}#ef4444{% elif budget.percent_used >= 80 %}#f59e0b{% else %}#16a34a{% endif %};">
              {{ budget.percent_used }}% used
            </div>
          </div>

          <div class="budget-amounts">
            <div class="budget-amount">
              <span class="label">Spent</span>
              <span class="value budget-spent {% if budget.is_over %}over{% endif %}">{% currency_symbol %}{{ budget.spent|floatformat:2|intcomma }}</span>
            </div>
            <div class="budget-amount">
              <span class="label">Remaining</span>
              <span class="value budget-remaining {% if budget.remaining >= 0 %}ok{% else %}over{% endif %}">{% currency_symbol %}{{ budget.remaining|floatformat:2|intcomma }}</span>
            </div>
            <div class="budget-amount">
              <span class="label">Budget</span>
              <span class="value budget-total">{% currency_symbol %}{{ budget.budget_amount|floatformat:2|intcomma }}</span>
            </div>
            <div class="budget-amount">
              <span class="label">Period</span>
              <span class="value budget-period-dates" style="font-size: 0.875rem;">{{ budget.period }}</span>
            </div>
          </div>

          <div class="budget-actions">
            <button class="btn btn-sm" onclick="openEditModal({{ budget.id }})">Edit</button>
            <button class="btn btn-sm" onclick="confirmDelete({{ budget.id }}, '{{ budget.name|escapejs }}')" style="background: #ef4444; color: white;">Delete</button>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="empty-state" id="empty-state">
      <h3>No budgets yet</h3>
      <p>Create your first budget to start tracking your spending limits.</p>
    </div>
  {% endif %}
</div>

<!-- Add Budget Modal -->
<div class="modal-overlay" id="addBudgetModal">
  <div class="modal-content" style="max-width: 600px;">
    <div class="modal-header">
      <h3>Add Budget</h3>
      <button class="modal-close" onclick="closeAddBudgetModal()">×</button>
    </div>
    <form method="post" action="{% url 'app_web:budgets' %}" id="add-budget-form">
      {% csrf_token %}
      <input type="hidden" name="action" value="create">

      <!-- Single row: Name, Amount, Period -->
      <div class="form-row-single">
        <div class="field-group">
          <label for="modal_name">Budget Name</label>
          <input type="text" name="name" id="modal_name" class="form-input" placeholder="Q4 Marketing" required>
        </div>

        <div class="field-group">
          <label for="modal_amount">Amount (£)</label>
          <input type="number" name="amount" id="modal_amount" class="form-input" placeholder="5000" step="0.01" min="0" required>
        </div>

        <div class="field-group">
          <label for="modal_period">Period</label>
          <select name="period" id="modal_period" class="form-select">
            <option value="monthly">Monthly</option>
            <option value="weekly">Weekly</option>
            <option value="yearly">Yearly</option>
            <option value="custom">Custom Date Range</option>
          </select>
        </div>
      </div>

      <!-- Labels -->
      <div class="field-group">
        <label>Track Labels (click to select)</label>
        <div class="label-pills-container empty" id="modal-labels-container">
          <!-- Populated by JavaScript -->
        </div>
        <small class="muted">Click labels to select (blue = selected)</small>
      </div>

      <!-- Custom Date Range -->
      <div class="date-range-fields" id="modal-date-range-fields">
        <div class="field-group">
          <label for="modal_start_date">Start Date</label>
          <input type="text" name="start_date" id="modal_start_date" class="form-input form-date" placeholder="Start date">
        </div>
        <div class="field-group">
          <label for="modal_end_date">End Date</label>
          <input type="text" name="end_date" id="modal_end_date" class="form-input form-date" placeholder="End date">
        </div>
      </div>

      <div class="field-group" style="margin-top: 1rem;">
        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
          <input type="checkbox" name="active" checked class="form-checkbox">
          <span>Active</span>
        </label>
      </div>

      <!-- Recurring Budget Options -->
      <div class="field-group" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
          <input type="checkbox" id="modal_is_recurring" name="is_recurring" class="form-checkbox" value="true">
          <span style="font-weight: 500;">Make this recurring</span>
        </label>
      </div>

      <div id="modal-recurring-options" style="display: none; margin-top: 0.75rem; padding: 0.75rem; background: #f9fafb; border-radius: 6px;">
        <div class="field-group" style="margin-bottom: 0;">
          <label for="modal_recurrence_count">Number of periods to create</label>
          <input type="number" name="recurrence_count" id="modal_recurrence_count" class="form-input" min="1" max="12" placeholder="3" style="max-width: 120px;">
          <small class="muted" style="display: block; margin-top: 0.25rem;">
            Creates budgets for the current period plus this many future periods.<br>
            Example: For monthly with 3, creates budgets for this month + next 3 months (4 total).
          </small>
        </div>
      </div>

      <div class="toolbar-actions" style="margin-top: 1.5rem;">
        <button type="submit" class="btn btn-primary" id="modal-submit-btn">Create Budget</button>
        <button type="button" class="btn" onclick="closeAddBudgetModal()">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Edit Budget Modal -->
<div class="modal-overlay" id="editModal">
  <div class="modal-content" style="max-width: 600px;">
    <div class="modal-header">
      <h3>Edit Budget</h3>
      <button class="modal-close" onclick="closeEditModal()">×</button>
    </div>
    <form method="post" action="{% url 'app_web:budgets' %}" id="edit-budget-form">
      {% csrf_token %}
      <input type="hidden" name="action" value="edit">
      <input type="hidden" name="budget_id" id="edit_budget_id">

      <!-- Single row: Name, Amount, Period -->
      <div class="form-row-single">
        <div class="field-group">
          <label for="edit_name">Budget Name</label>
          <input type="text" name="name" id="edit_name" class="form-input" placeholder="Q4 Marketing" required>
        </div>

        <div class="field-group">
          <label for="edit_amount">Amount (£)</label>
          <input type="number" name="amount" id="edit_amount" class="form-input" placeholder="5000" step="0.01" min="0" required>
        </div>

        <div class="field-group">
          <label for="edit_period">Period</label>
          <select name="period" id="edit_period" class="form-select">
            <option value="monthly">Monthly</option>
            <option value="weekly">Weekly</option>
            <option value="yearly">Yearly</option>
            <option value="custom">Custom Date Range</option>
          </select>
        </div>
      </div>

      <!-- Labels -->
      <div class="field-group">
        <label>Track Labels (click to select)</label>
        <div class="label-pills-container" id="edit-labels-container">
          <!-- Populated by JavaScript -->
        </div>
        <small class="muted">Click labels to select (blue = selected)</small>
      </div>

      <!-- Custom Date Range -->
      <div class="date-range-fields" id="edit-date-range-fields">
        <div class="field-group">
          <label for="edit_start_date">Start Date</label>
          <input type="text" name="start_date" id="edit_start_date" class="form-input form-date" placeholder="Start date">
        </div>
        <div class="field-group">
          <label for="edit_end_date">End Date</label>
          <input type="text" name="end_date" id="edit_end_date" class="form-input form-date" placeholder="End date">
        </div>
      </div>

      <div class="field-group" style="margin-top: 1rem;">
        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
          <input type="checkbox" name="active" id="edit_active" class="form-checkbox">
          <span>Active</span>
        </label>
      </div>

      <!-- Recurring Budget Edit Options -->
      <div id="edit-recurring-options" style="display: none; margin-top: 1rem; padding: 1rem; background: #f9fafb; border-radius: 6px;">
        <input type="hidden" name="recurring_group_id" id="edit_recurring_group_id">
        <div class="field-group" style="margin-bottom: 0;">
          <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Apply changes to:</label>
          <div style="display: flex; flex-direction: column; gap: 0.5rem;">
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
              <input type="radio" name="edit_scope" value="this" checked class="form-radio">
              <span>This budget only</span>
            </label>
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
              <input type="radio" name="edit_scope" value="future" class="form-radio">
              <span>This and all future budgets in this series</span>
            </label>
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
              <input type="radio" name="edit_scope" value="all" class="form-radio">
              <span>All budgets in this series (past and future)</span>
            </label>
          </div>
          <small class="muted" style="display: block; margin-top: 0.5rem;">
            This budget is part of a recurring series. Choose how broadly to apply your changes.
          </small>
        </div>
      </div>

      <div class="toolbar-actions" style="margin-top: 1.5rem;">
        <button type="submit" class="btn btn-primary">Update Budget</button>
        <button type="button" class="btn" onclick="closeEditModal()">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal-overlay" id="deleteModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="deleteModalTitle">Delete Budget</h3>
      <button class="modal-close" onclick="closeDeleteModal()">×</button>
    </div>
    <div id="deleteSingleContent">
      <p>Are you sure you want to delete budget "<strong id="deleteBudgetName"></strong>"?</p>
      <p class="muted" style="font-size: 0.875rem;">This action cannot be undone.</p>
    </div>
    <div id="deleteBulkContent" style="display: none;">
      <p>Are you sure you want to delete <strong id="deleteBulkCount">0</strong> budgets?</p>
      <p class="muted" style="font-size: 0.875rem;">This action cannot be undone.</p>
    </div>
    <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
      <button class="btn" onclick="closeDeleteModal()">Cancel</button>
      <button class="btn" style="background: #ef4444; color: white;" onclick="deleteBudget()">
        <span id="deleteButtonText">Delete Budget</span>
      </button>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<!-- Flatpickr for date pickers -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<!-- Set budget data for JavaScript -->
<script>
  window.budgetSummaryData = {{ budget_summary_json|safe }};
</script>
<!-- Budget JavaScript -->
<script src="{% static 'app_web/budgets.js' %}"></script>
{% endblock %}
