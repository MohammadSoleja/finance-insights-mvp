{% extends "base.html" %}
{% load static humanize currency_tags %}
{% block title %}{{ title|default:"Dashboard" }} — Finance Insights{% endblock %}

{% block head_extra %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<!-- flatpickr for consistent date picker -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<!-- Dashboard Styles -->
<link rel="stylesheet" href="{% static 'app_web/dashboard.css' %}">
{% endblock %}

{% block content %}
  <!-- Standardized Toolbar -->
  <div class="page-toolbar">
    <div class="toolbar-content">
      <!-- Frequency Tabs -->
      <div class="toolbar-freq-tabs" role="tablist" aria-label="Frequency">
        {% with base=base_qs %}
          <a class="btn" href="?{{ base }}{% if base %}&amp;{% endif %}freq=D" {% if freq == 'D' %}aria-current="page"{% endif %}>Daily</a>
          <a class="btn" href="?{{ base }}{% if base %}&amp;{% endif %}freq=W" {% if freq == 'W' %}aria-current="page"{% endif %}>Weekly</a>
          <a class="btn" href="?{{ base }}{% if base %}&amp;{% endif %}freq=M" {% if freq == 'M' %}aria-current="page"{% endif %}>Monthly</a>
          <a class="btn" href="?{{ base }}{% if base %}&amp;{% endif %}freq=Y" {% if freq == 'Y' %}aria-current="page"{% endif %}>YTD</a>
        {% endwith %}
      </div>

      <!-- Search -->
      <div class="toolbar-search">
        <form method="get" style="margin: 0;">
          <input type="hidden" name="freq" value="{{ freq }}" />
          <input id="q" aria-label="Search" class="form-input" type="text" name="q" placeholder="Search transactions..." value="{{ request.GET.q|default:'' }}" />
        </form>
      </div>

      <!-- Date Range -->
      <div class="toolbar-date">
        <form method="get" style="margin: 0;">
          <input type="hidden" name="freq" value="{{ freq }}" />
          <input id="start_date" aria-label="Start date" name="start" type="text" class="form-input" value="{{ start }}" placeholder="Start date" />
        </form>
      </div>

      <div class="toolbar-date">
        <form method="get" style="margin: 0;">
          <input type="hidden" name="freq" value="{{ freq }}" />
          <input id="end_date" aria-label="End date" name="end" type="text" class="form-input" value="{{ end }}" placeholder="End date" />
        </form>
      </div>

      <!-- Category Filter -->
      <div class="toolbar-select">
        <form method="get" style="margin: 0;">
          <input type="hidden" name="freq" value="{{ freq }}" />
          <select id="category" aria-label="Category" name="category" class="form-select">
            <option value="">All Categories</option>
            {% for c in categories %}
              <option value="{{ c }}" {% if c == category %}selected{% endif %}>{{ c }}</option>
            {% endfor %}
          </select>
        </form>
      </div>

      <!-- Actions -->
      <div class="toolbar-actions">
        <a href="/dashboard/" class="btn btn-secondary">Reset</a>
        <button class="btn btn-primary" type="submit" form="dashboard-filters">Apply</button>
      </div>
    </div>
  </div>

  <!-- Hidden form for combined submit -->
  <form id="dashboard-filters" method="get" style="display: none;">
    <input type="hidden" name="freq" value="{{ freq }}" />
  </form>

  <div class="kpi-grid">
    <!-- Total Outflow (with sparkline) -->
    <div class="card numeric"><div>
        <div class="muted">Total Outflow</div>
        {% if kpi.tx_count|default:0 > 0 %}
          <div class="kpi" tabindex="0" aria-label="Total outflow {% currency_symbol %}{{ kpi.outflow|floatformat:2|intcomma }}">{% currency_symbol %}{{ kpi.outflow|floatformat:2|intcomma }}</div>
          {% with d=kpi_delta.outflow %}
            {% if d %}
              <div class="kpi-delta {% if d.abs >= 0 %}negative{% else %}positive{% endif %}" tabindex="0" aria-label="Change {{ d.abs|floatformat:2|intcomma }} {% org_currency %}, {{ d.pct|default:'no' }} percent compared to previous period">
                <span class="arrow">{% if d.abs >= 0 %}▲{% else %}▼{% endif %}</span>
                <span>{% currency_symbol %}{{ d.abs|floatformat:2|intcomma }}</span>
                {% if d.pct is not None %}<span>({{ d.pct }}%)</span>{% endif %}
              </div>
            {% endif %}
          {% endwith %}
          <div id="outflow-sparkline" class="sparkline-container" style="margin-top: 0.5rem;"></div>
        {% else %}
          <div class="kpi">—</div>
          <div class="muted" title="No data in selected period">No data in selected period</div>
        {% endif %}
      </div></div>
      </div></div>

    <!-- Total Inflow (with sparkline) -->
    <div class="card numeric"><div>
        <div class="muted">Total Inflow</div>
        {% if kpi.tx_count|default:0 > 0 %}
          <div class="kpi" tabindex="0" aria-label="Total inflow {% currency_symbol %}{{ kpi.inflow|floatformat:2|intcomma }}">{% currency_symbol %}{{ kpi.inflow|floatformat:2|intcomma }}</div>
          {% with d=kpi_delta.inflow %}
            {% if d %}
              <div class="kpi-delta {% if d.abs >= 0 %}positive{% else %}negative{% endif %}" tabindex="0" aria-label="Change {{ d.abs|floatformat:2|intcomma }} {% org_currency %}, {{ d.pct|default:'no' }} percent compared to previous period">
                <span class="arrow">{% if d.abs >= 0 %}▲{% else %}▼{% endif %}</span>
                <span>{% currency_symbol %}{{ d.abs|floatformat:2|intcomma }}</span>
                {% if d.pct is not None %}<span>({{ d.pct }}%)</span>{% endif %}
              </div>
            {% endif %}
          {% endwith %}
          <div id="inflow-sparkline" class="sparkline-container" style="margin-top: 0.5rem;"></div>
        {% else %}
          <div class="kpi">—</div>
          <div class="muted" title="No data in selected period">No data in selected period</div>
        {% endif %}
      </div></div>

    <!-- Net (with sparkline) -->
    <div class="card numeric"><div>
        <div class="muted">Net</div>
        {% if kpi.tx_count|default:0 > 0 %}
          <div class="kpi" tabindex="0" aria-label="Net {% currency_symbol %}{{ kpi.net|floatformat:2|intcomma }}">{% currency_symbol %}{{ kpi.net|floatformat:2|intcomma }}</div>
          {% with d=kpi_delta.net %}
            {% if d %}
              <div class="kpi-delta {% if d.abs >= 0 %}positive{% else %}negative{% endif %}" tabindex="0" aria-label="Change {{ d.abs|floatformat:2|intcomma }} {% org_currency %}, {{ d.pct|default:'no' }} percent compared to previous period">
                <span class="arrow">{% if d.abs >= 0 %}▲{% else %}▼{% endif %}</span>
                <span>{% currency_symbol %}{{ d.abs|floatformat:2|intcomma }}</span>
                {% if d.pct is not None %}<span>({{ d.pct }}%)</span>{% endif %}
              </div>
            {% endif %}
          {% endwith %}
          <div id="net-sparkline" class="sparkline-container" style="margin-top: 0.5rem;"></div>
        {% else %}
          <div class="kpi">—</div>
          <div class="muted" title="No data in selected period">No data in selected period</div>
        {% endif %}
      </div></div>

    <!-- Top Outflows (compact list) -->
    <div class="card"><div>
        <div class="muted">Top 3 Outflow Categories</div>
        {% if top_outflows %}
          <div class="cat-list">
            {% for t in top_outflows %}
              <div class="cat-item" role="group" aria-label="Top outflow {{ forloop.counter }}">
                <div class="cat-name" title="{{ t.name }}">{{ t.name }}</div>
                <div class="cat-pct">{{ t.percent|default:'—' }}%</div>
                {% if t.change is not None %}
                  <div class="cat-change {% if t.change >= 0 %}negative{% else %}positive{% endif %}" aria-hidden="false">
                    <span class="arrow">{% if t.change >= 0 %}▲{% else %}▼{% endif %}</span>
                    <span>{{ t.change_abs }}pp</span>
                  </div>
                {% else %}
                  <div class="cat-change" aria-hidden="true">&nbsp;</div>
                {% endif %}
              </div>
             {% endfor %}
           </div>
         {% else %}
           <div class="muted">—</div>
         {% endif %}
       </div></div>

     <!-- Top Inflows (compact list) -->
     <div class="card"><div>
         <div class="muted">Top 3 Inflow Categories</div>
         {% if top_inflows %}
           <div class="cat-list">
             {% for t in top_inflows %}
               <div class="cat-item" role="group" aria-label="Top inflow {{ forloop.counter }}">
                 <div class="cat-name" title="{{ t.name }}">{{ t.name }}</div>
                 <div class="cat-pct">{{ t.percent|default:'—' }}%</div>
                 {% if t.change is not None %}
                   <div class="cat-change {% if t.change >= 0 %}positive{% else %}negative{% endif %}" aria-hidden="false">
                     <span class="arrow">{% if t.change >= 0 %}▲{% else %}▼{% endif %}</span>
                     <span>{{ t.change_abs }}pp</span>
                   </div>
                 {% else %}
                   <div class="cat-change" aria-hidden="true">&nbsp;</div>
                 {% endif %}
               </div>
             {% endfor %}
           </div>
         {% else %}
           <div class="muted">—</div>
         {% endif %}
       </div></div>
  </div>

  <!-- Removed redundant transaction/frequency text — filters show this info -->

  {% if no_results %}
    <div class="card muted">No transactions found for the selected filters.</div>
  {% else %}
    <div class="charts">
      <div class="card">
        <h3>Revenue vs Expenses vs Net</h3>
        <div class="chart-wrap"><canvas id="tsChart" aria-label="Time series chart" role="img"></canvas></div>
      </div>
      <div class="card">
        <h3>Top Categories</h3>
        <div class="chart-wrap"><canvas id="catChart" aria-label="Top categories chart" role="img"></canvas></div>

        <div class="pie-header">
          <h3>Distribution</h3>
          <select id="pieMode" class="form-select">
            <option value="categories">Categories</option>
            <option value="direction">Direction</option>
          </select>
        </div>
        <div class="pie-chart-container">
          <canvas id="pieChart" aria-label="Distribution pie chart" role="img"></canvas>
        </div>
      </div>
    </div>
  {% endif %}

  <!-- Budget Summary Widget -->
  {% if budget_summary %}
  <div class="card mt-1">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
      <h3 class="mt-0" style="margin: 0;">Budget Overview</h3>
      <a href="{% url 'app_web:budgets' %}" class="btn btn-sm">Manage Budgets</a>
    </div>

    {% if budget_summary %}
      <div style="display: grid; gap: 0.75rem;">
        {% for budget in budget_summary %}
          <div style="border: 1px solid rgba(16,24,40,0.06); border-radius: 6px; padding: 0.75rem; {% if budget.is_over %}border-left: 4px solid #ef4444;{% elif budget.percent_used >= 80 %}border-left: 4px solid #f59e0b;{% else %}border-left: 4px solid #16a34a;{% endif %}">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
              <div>
                <div style="font-weight: 700; color: #111827;">{{ budget.category }}</div>
                <div style="font-size: 0.875rem; color: #6b7280;">{{ budget.period }}</div>
              </div>
              <div style="text-align: right;">
                <div style="font-weight: 700; font-size: 0.875rem; color: {% if budget.is_over %}#ef4444{% elif budget.percent_used >= 80 %}#f59e0b{% else %}#16a34a{% endif %};">
                  {{ budget.percent_used }}%
                </div>
              </div>
            </div>

            <div style="width: 100%; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; margin-bottom: 0.5rem;">
              <div style="height: 100%; {% if budget.is_over %}background: #ef4444;{% elif budget.percent_used >= 80 %}background: #f59e0b;{% else %}background: #16a34a;{% endif %} width: {% if budget.percent_used > 100 %}100{% else %}{{ budget.percent_used }}{% endif %}%; transition: width 0.3s;"></div>
            </div>

            <div style="display: flex; justify-content: space-between; font-size: 0.875rem;">
              <span style="color: #6b7280;">£{{ budget.spent|floatformat:2|intcomma }} / £{{ budget.budget_amount|floatformat:2|intcomma }}</span>
              <span style="{% if budget.remaining >= 0 %}color: #16a34a;{% else %}color: #ef4444;{% endif %} font-weight: 600;">£{{ budget.remaining|floatformat:2|intcomma }} left</span>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="muted">No active budgets. <a href="{% url 'app_web:budgets' %}">Create one</a> to track spending.</div>
    {% endif %}
  </div>
  {% endif %}

  <div class="card mt-1">
  <h3 class="mt-0">AI-style Insights</h3>
  {% if insights %}
    <ul class="mt-1">
      {% for i in insights %}
        <li>
          <strong>{{ i.title }}:</strong> {{ i.text }}
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <div class="muted">No insights yet.</div>
  {% endif %}
</div>

  <!-- Embed data as JSON (no inline executable JS) -->
  <script id="chart-data" type="application/json">{{ chart_payload|safe }}</script>
{% endblock %}

{% block scripts %}
  <script src="{% static 'app_web/dashboard.js' %}"></script>
  <script>
    // Initialize flatpickr on dashboard date inputs to match transactions styling & behavior
    (function(){
      document.addEventListener('DOMContentLoaded', function(){
        if(window.flatpickr){
          var opts = { dateFormat: 'Y-m-d', allowInput: true };
          flatpickr('#start_date', opts);
          flatpickr('#end_date', opts);
        }

        // Generate sparklines for KPI cards using actual historical data
        const outflowContainer = document.getElementById('outflow-sparkline');
        const inflowContainer = document.getElementById('inflow-sparkline');
        const netContainer = document.getElementById('net-sparkline');

        console.log('Sparkline containers:', { outflowContainer, inflowContainer, netContainer });
        console.log('createSparkline function exists:', typeof createSparkline);

        if (outflowContainer) {
          try {
            // Use actual 7-day historical data from backend if available
            const outflowData = {{ sparkline_outflow|default:"[]"|safe }};
            console.log('Outflow sparkline data:', outflowData);

            if (typeof createSparkline === 'function') {
              // Show sparkline even if all zeros (flat line = no activity)
              if (outflowData && outflowData.length > 0) {
                const sparklineHTML = createSparkline(outflowData, 80, 28, '#ef4444');
                console.log('Generated outflow sparkline HTML:', sparklineHTML);
                outflowContainer.innerHTML = sparklineHTML;
              } else {
                console.log('No outflow data available (empty array)');
              }
            } else {
              console.error('createSparkline function not found');
            }
          } catch (e) {
            console.error('Error generating outflow sparkline:', e);
          }
        } else {
          console.log('Outflow container not found');
        }

        if (inflowContainer) {
          try {
            // Use actual 7-day historical data from backend if available
            const inflowData = {{ sparkline_inflow|default:"[]"|safe }};
            console.log('Inflow sparkline data:', inflowData);

            if (typeof createSparkline === 'function') {
              // Show sparkline even if all zeros (flat line = no activity)
              if (inflowData && inflowData.length > 0) {
                const sparklineHTML = createSparkline(inflowData, 80, 28, '#10b981');
                console.log('Generated inflow sparkline HTML:', sparklineHTML);
                inflowContainer.innerHTML = sparklineHTML;
              } else {
                console.log('No inflow data available (empty array)');
              }
            } else {
              console.error('createSparkline function not found');
            }
          } catch (e) {
            console.error('Error generating inflow sparkline:', e);
          }
        } else {
          console.log('Inflow container not found');
        }

        if (netContainer) {
          try {
            // Use actual 7-day historical data from backend if available
            const netData = {{ sparkline_net|default:"[]"|safe }};
            console.log('Net sparkline data:', netData);

            if (typeof createSparkline === 'function') {
              // Show sparkline even if all zeros (flat line = no activity)
              if (netData && netData.length > 0) {
                const sparklineHTML = createSparkline(netData, 80, 28, '#2563eb');
                console.log('Generated net sparkline HTML:', sparklineHTML);
                netContainer.innerHTML = sparklineHTML;
              } else {
                console.log('No net data available (empty array)');
              }
            } else {
              console.error('createSparkline function not found');
            }
          } catch (e) {
            console.error('Error generating net sparkline:', e);
          }
        } else {
          console.log('Net container not found');
        }
      });
    })();
  </script>
{% endblock %}