{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>{{ title|default:"Upload" }} â€” Finance Insights</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 2rem; }
    .card { max-width: 900px; padding: 1.5rem; border: 1px solid #e5e7eb; border-radius: 12px; }
    .row { margin: .5rem 0; }
    .success { background:#ecfdf5; border:1px solid #10b981; padding:.75rem; border-radius:8px; margin-bottom:1rem; }
    .error { background:#fef2f2; border:1px solid #ef4444; padding:.75rem; border-radius:8px; margin-bottom:1rem; }
    .warn  { background:#fffbeb; border:1px solid #f59e0b; padding:.75rem; border-radius:8px; margin-bottom:1rem; }
    .errorlist { color: #b91c1c; margin: .5rem 0 0 0; list-style: disc; padding-left: 1.25rem; }
    button { padding: .6rem 1rem; border-radius: 8px; border: 1px solid #d1d5db; background: #111827; color: #fff; cursor: pointer; }
    button:hover { opacity: .9; }
    input[type=file] { width: 100%; }
    small { color: #6b7280; }
    .tablewrap { overflow:auto; border:1px solid #e5e7eb; border-radius:8px; }
    .preview-table { width:100%; border-collapse: collapse; }
    .preview-table th, .preview-table td { padding:.5rem; border-bottom:1px solid #eee; text-align:left; }
    .preview-table thead th { background:#f9fafb; }
  </style>
</head>
<body>
  <h1>{{ title|default:"Upload Transactions" }}</h1>

  <div class="card">

    {% if success %}
      <div class="success">
        <strong>Upload successful:</strong> {{ uploaded_name }} ({{ uploaded_size }} bytes).
        <div><small>Rows detected: {{ row_count }}</small></div>
      </div>
    {% endif %}

    {% if errors %}
      <div class="error">
        <strong>We found an issue:</strong>
        <ul class="errorlist">
          {% for e in errors %}<li>{{ e }}</li>{% endfor %}
        </ul>
      </div>
    {% endif %}

    {% if warnings and not errors %}
      <div class="warn">
        <strong>Heads up:</strong>
        <ul>
          {% for w in warnings %}<li>{{ w }}</li>{% endfor %}
        </ul>
      </div>
    {% endif %}

    <!-- Upload form -->
    <form method="post" enctype="multipart/form-data" novalidate>
      {% csrf_token %}
      <div class="row">
        {{ form.file.label_tag }}<br>
        {{ form.file }}
        {% if form.file.help_text %}<div><small>{{ form.file.help_text }}</small></div>{% endif %}
        {{ form.file.errors }}
      </div>
      <div class="row">
        <button type="submit">Upload</button>
      </div>
    </form>

    {% if preview_html and not errors %}
      <h3 style="margin-top:1.5rem;">Preview (first 20 rows)</h3>
      <div class="tablewrap">
        {{ preview_html|safe }}
      </div>

      <!-- Save button (second post) -->
      <form method="post" style="margin-top:1rem;">
        {% csrf_token %}
        <input type="hidden" name="action" value="save">
        <input type="hidden" name="file_b64" value="{{ file_b64 }}">
        <input type="hidden" name="filename" value="{{ filename }}">
        <button type="submit">Save to database</button>
      </form>
    {% endif %}

    {% if saved %}
      <div class="success" style="margin-top:1rem;">
        <strong>Saved:</strong> {{ saved_count }} rows added to the database.
      </div>
    {% endif %}

  </div>
</body>
</html>
