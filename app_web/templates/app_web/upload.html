{% extends "base.html" %}
{% block title %}{{ title|default:"Upload" }} ‚Äî Finance Insights{% endblock %}

{% block head_extra %}
  <!-- flatpickr for consistent date picker -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
{% endblock %}

{% block content %}

  <!-- Upload card (title inside box) -->
  <div class="card">
    <h2 class="card-title">Upload Transactions</h2>

    {% if success %}
      <div class="success">
        <strong>Upload successful:</strong> {{ uploaded_name }} ({{ uploaded_size }} bytes).
        <div><small>Rows detected: {{ row_count }}</small></div>
      </div>
    {% endif %}

    {% if errors %}
      <div class="error">
        <strong>We found an issue:</strong>
        <ul class="errorlist">
          {% for e in errors %}<li>{{ e }}</li>{% endfor %}
        </ul>
        {% if result.example_header %}
          <div style="margin-top:.5rem">
            <strong>Example header found:</strong>
            <pre style="white-space:pre-wrap;padding:.5rem;border:1px solid var(--border);border-radius:6px;background:#fafafa">{{ result.example_header }}</pre>
          </div>
        {% endif %}
      </div>
    {% endif %}

    {% if result.rejected_count and result.rejected_count > 0 %}
      <div class="warn" style="margin-top:.5rem">
        <strong>Rejected rows:</strong> {{ result.rejected_count }} rows were rejected during validation.
        <ul>
          {% for item in result.rejection_summary %}
            <li>{{ item.count }} √ó {{ item.reason }}</li>
          {% endfor %}
        </ul>
        {% if result.rejected_csv_b64 %}
          <a class="btn btn-ghost" href="data:text/csv;base64,{{ result.rejected_csv_b64 }}" download="rejected_rows.csv">Download rejected rows (CSV)</a>
        {% endif %}
      </div>
    {% endif %}

    {% if warnings and not errors %}
      <div class="warn">
        <strong>Heads up:</strong>
        <ul>
          {% for w in warnings %}<li>{{ w }}</li>{% endfor %}
        </ul>
      </div>
    {% endif %}

    <!-- Modern dropzone upload -->
    <form method="post" enctype="multipart/form-data" novalidate id="upload-form">
      {% csrf_token %}
      <div class="upload-inner">
        <label class="dropzone" id="dropzone" for="id_file">
          <div class="dz-inner">
            <div class="dz-icon" aria-hidden="true">üìÅ</div>
            <div class="dz-note">Drop a CSV/XLSX here or click to select a file</div>
            <div class="dz-filename" id="dz-filename" aria-live="polite"></div>
          </div>
          {{ form.file }}
        </label>

        <div>
          <button class="btn btn-primary" type="submit">Upload</button>
        </div>
      </div>
    </form>

    {% if preview_html and not errors %}
      <h3 class="mt-1-5">Preview (first 20 rows)</h3>
      <div class="tablewrap">
        {{ preview_html|safe }}
      </div>

      <!-- Save button (second post) -->
      <form method="post" class="mt-1">
        {% csrf_token %}
        <input type="hidden" name="action" value="save">
        <input type="hidden" name="file_b64" value="{{ file_b64 }}">
        <input type="hidden" name="filename" value="{{ filename }}">
        <button class="btn btn-primary" type="submit">Save to database</button>
      </form>
    {% endif %}

    {% if saved %}
      <div class="success mt-1">
        <strong>Saved:</strong> {{ saved_count }} rows added to the database.
      </div>
    {% endif %}

  </div>

  <!-- Add Transaction moved to Transactions page modal -->

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    // helper to get CSRF token from cookie (Django default)
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          // Does this cookie string begin with the name we want?
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    // Dropzone behavior (drag/drop + click to open)
    (function(){
      const dz = document.getElementById('dropzone');
      const fileInput = document.getElementById('id_file');
      const nameEl = document.getElementById('dz-filename');
      if(!dz || !fileInput) return;

      function setFilename(f){ if(f) nameEl.textContent = f.name; else nameEl.textContent = ''; }

      dz.addEventListener('click', function(e){ fileInput.click(); });
      dz.addEventListener('dragover', function(e){ e.preventDefault(); dz.classList.add('dragover'); });
      dz.addEventListener('dragleave', function(e){ e.preventDefault(); dz.classList.remove('dragover'); });
      dz.addEventListener('drop', function(e){
        e.preventDefault(); dz.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if(files && files.length){
          // use DataTransfer to set file input files
          const dt = new DataTransfer();
          for(let i=0;i<files.length;i++) dt.items.add(files[i]);
          fileInput.files = dt.files;
          setFilename(files[0]);
        }
      });

      fileInput.addEventListener('change', function(){ const f = fileInput.files && fileInput.files[0]; setFilename(f); });
    })();

    // Initialize flatpickr on date field
    (function(){
      if(window.flatpickr){
        flatpickr('#tx-date', { dateFormat: 'Y-m-d', defaultDate: new Date() });
      }
    })();

    // Toast helper
    function showToast(msg, type=''){
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.className = 'toast show ' + (type || '');
      setTimeout(()=>{ el.className = 'toast'; }, 4500);
    }

    // AJAX submit for Add Transaction form
    (function(){
      const form = document.getElementById('add-tx-form');
      const errorsEl = document.getElementById('add-errors');
      if(!form) return;
      form.addEventListener('submit', function(e){
        e.preventDefault();
        errorsEl.innerHTML = '';
        const fd = new FormData(form);
        fd.set('action', 'add_tx');
        const url = window.location.pathname;
        fetch(url, {
          method: 'POST',
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: fd
        }).then(async (res)=>{
          const data = await res.json().catch(()=>null);
          if(res.ok && data && data.ok){
            showToast('Transaction added', 'success');
            // clear form fields
            form.reset();
            if(window.flatpickr){ flatpickr('#tx-date').clear(); }
          } else {
            const errs = (data && data.errors) || ['Failed to save transaction'];
            const ul = document.createElement('ul');
            errs.forEach(err=>{ const li = document.createElement('li'); li.textContent = err; ul.appendChild(li); });
            errorsEl.appendChild(ul);
            showToast(errs.join('; '), 'error');
          }
        }).catch((err)=>{
          errorsEl.textContent = 'Network error';
          showToast('Network error', 'error');
        });
      });
    })();
  </script>

{% endblock %}
