{% extends "base.html" %}
{% block title %}{{ title|default:"Upload" }} — Finance Insights{% endblock %}

{% block head_extra %}{% endblock %}

{% block content %}
  <h1>{{ title|default:"Upload Transactions" }}</h1>

  <div class="card">

    {% if success %}
      <div class="success">
        <strong>Upload successful:</strong> {{ uploaded_name }} ({{ uploaded_size }} bytes).
        <div><small>Rows detected: {{ row_count }}</small></div>
      </div>
    {% endif %}

    {% if errors %}
      <div class="error">
        <strong>We found an issue:</strong>
        <ul class="errorlist">
          {% for e in errors %}<li>{{ e }}</li>{% endfor %}
        </ul>
        {% if result.example_header %}
          <div style="margin-top:.5rem">
            <strong>Example header found:</strong>
            <pre style="white-space:pre-wrap;padding:.5rem;border:1px solid var(--border);border-radius:6px;background:#fafafa">{{ result.example_header }}</pre>
          </div>
        {% endif %}
      </div>
    {% endif %}

    {% if result.rejected_count and result.rejected_count > 0 %}
      <div class="warn" style="margin-top:.5rem">
        <strong>Rejected rows:</strong> {{ result.rejected_count }} rows were rejected during validation.
        <ul>
          {% for item in result.rejection_summary %}
            <li>{{ item.count }} × {{ item.reason }}</li>
          {% endfor %}
        </ul>
        {% if result.rejected_csv_b64 %}
          <a class="btn btn-ghost" href="data:text/csv;base64,{{ result.rejected_csv_b64 }}" download="rejected_rows.csv">Download rejected rows (CSV)</a>
        {% endif %}
      </div>
    {% endif %}

    {% if warnings and not errors %}
      <div class="warn">
        <strong>Heads up:</strong>
        <ul>
          {% for w in warnings %}<li>{{ w }}</li>{% endfor %}
        </ul>
      </div>
    {% endif %}

    <!-- Upload form -->
    <form method="post" enctype="multipart/form-data" novalidate>
      {% csrf_token %}
      <div class="row">
        {{ form.file.label_tag }}<br>
        {{ form.file }}
        {% if form.file.help_text %}<div><small>{{ form.file.help_text }}</small></div>{% endif %}
        {{ form.file.errors }}
      </div>
      <div class="row">
        <button class="btn btn-primary" type="submit">Upload</button>
      </div>
    </form>

    {% if preview_html and not errors %}
      <h3 class="mt-1-5">Preview (first 20 rows)</h3>
      <div class="tablewrap">
        {{ preview_html|safe }}
      </div>

      <!-- Save button (second post) -->
      <form method="post" class="mt-1">
        {% csrf_token %}
        <input type="hidden" name="action" value="save">
        <input type="hidden" name="file_b64" value="{{ file_b64 }}">
        <input type="hidden" name="filename" value="{{ filename }}">
        <button class="btn btn-primary" type="submit">Save to database</button>
      </form>
    {% endif %}

    {% if saved %}
      <div class="success mt-1">
        <strong>Saved:</strong> {{ saved_count }} rows added to the database.
      </div>
    {% endif %}

  </div>
{% endblock %}
