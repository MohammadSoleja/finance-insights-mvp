{% extends "base.html" %}
{% load static %}
{% block title %}Transactions — Finance Insights{% endblock %}

{% block head_extra %}
  <!-- flatpickr for consistent date picker like Upload page -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <!-- Inline override styles (high specificity) to ensure toolbar is a single inline row and inputs share styling) -->
  <style>
     :root { --brand: #111827; --muted: #6b7280; }
     /* Responsive grid layout for toolbar (Actions | Search | Start | End | Direction | Sort) */
    .toolbar { display: grid !important; grid-auto-rows: auto !important;
               /* search | start | end | direction | sort | actions (actions last)
                  make start/end date columns smaller and slightly tighten spacing */
               grid-template-columns: minmax(160px,250px) 115px 115px 100px 130px auto !important;
               gap: .6rem !important; align-items: center !important; width:100%; max-width:100%; box-sizing:border-box; }
     .toolbar > * { margin: 0 !important; display: flex !important; align-items: center !important; }
     /* Make all toolbar controls the same height, padding and baseline so they align */
     .toolbar { align-items: center !important; }
     /* uniform sizing for precise alignment */
     .toolbar > * { min-height: 44px !important; display: inline-flex !important; align-items: center !important; }
     .toolbar .field-group { height: 44px !important; display: inline-flex !important; align-items: center !important; gap: .4rem !important; }
    /* allow controls to shrink and not force the grid to overflow; increase size for readability */
    /* Compact input sizing so toolbar fits comfortably */
    .toolbar .form-input, .toolbar .form-select, .toolbar .form-date { width: 100% !important; max-width: 100% !important; min-width: 0 !important; box-sizing: border-box !important; color: var(--brand) !important; font-size: 0.95rem !important; background: #fff !important; height: 40px !important; padding: 8px 10px !important; line-height: 1 !important; display: inline-flex !important; align-items: center !important; vertical-align: middle !important; border-radius: 6px !important; }
    /* ensure sr-only labels don't take space */
    .toolbar .field-group > label.sr-only { position: absolute !important; width: 1px !important; height: 1px !important; padding: 0 !important; margin: -1px !important; overflow: hidden !important; clip: rect(0 0 0 0) !important; border: 0 !important; }
    /* Ensure inner text vertically centers consistently across browsers */
    .toolbar .form-input::-webkit-input-placeholder, .toolbar .form-date::-webkit-input-placeholder { line-height: 1 !important; }
    .toolbar .form-input::-moz-placeholder, .toolbar .form-date::-moz-placeholder { line-height: 1 !important; }
    .toolbar .form-input:-ms-input-placeholder, .toolbar .form-date:-ms-input-placeholder { line-height: 1 !important; }
    .toolbar .form-input::placeholder, .toolbar .form-date::placeholder { line-height: 1 !important; }
    /* Remove any baseline shift and ensure consistent font metrics */
    .toolbar input, .toolbar select { font-family: inherit !important; font-size: 0.95rem !important; vertical-align: middle !important; box-sizing: border-box !important; }
     /* Keep default .btn sizing; only override the secondary toolbar buttons so they visually match Reset/Apply */
     .toolbar-secondary .btn {
       height: 40px !important;
       padding: 6px 12px !important;
       display: inline-flex !important;
       align-items: center !important;
       justify-content: center !important;
       border-radius: 6px !important;
       font-size: 0.95rem !important;
       box-sizing: border-box !important;
       width: auto !important; /* let width be content-based so it matches Reset/Apply */
     }
     /* Remove default margins from inputs/selects */
     .toolbar input, .toolbar select { margin: 0 !important; }
     .toolbar label { color: var(--muted) !important; }
    /* keep actions aligned to the end and give buttons spacing */
    .toolbar-actions { justify-self: end !important; display: flex !important; gap: .6rem !important; }
    /* Secondary toolbar (below filters) for columns/edit/delete; right-aligned under Reset/Apply */
    .toolbar-secondary { display:flex; gap:.5rem; align-items:center; margin-top:.5rem; justify-content:flex-end; }
    @media (max-width:900px){ .toolbar-secondary{ flex-wrap:wrap; gap:.5rem; } }
    @media (max-width:720px){ .toolbar-secondary{ grid-column:1/-1 !important; grid-row:auto !important; justify-self:flex-start !important; } }
     .toolbar * { align-self: center !important; }
     /* Ensure the visible text (values) inside the date inputs have the same color */
     .toolbar input, .toolbar select, .toolbar .flatpickr-input { color: var(--brand) !important; }
     /* Make placeholder/inactive text muted but consistent */
     .toolbar input::placeholder, .toolbar select::placeholder { color: var(--muted) !important; }
     /* On very small screens allow wrapping back to vertical flow */
     @media (max-width: 420px) { .toolbar { display:flex !important; flex-wrap:wrap !important; } }
     /* On small screens revert to stacked, but keep visual parity */
     @media (max-width: 900px) {
        /* switch to wrapped flex layout on narrower screens so items don't overflow */
        .toolbar { display: flex !important; flex-wrap: wrap !important; gap: .5rem !important; }
        .toolbar > * { flex: 0 0 auto !important; }
        .toolbar .field-group { flex: 1 1 48% !important; min-width: 140px !important; }
        .toolbar .dir-field, .toolbar .sort-field { flex: 0 0 48% !important; min-width: 120px !important; }
        .toolbar-actions { width: 100% !important; display:flex !important; justify-content:flex-end !important; }
      }
     /* Ensure flatpickr doesn't change input color */
     .flatpickr-input { color: var(--brand) !important; }

    /* Modal animation, spinner and row highlight */
    .modal { transition: opacity .18s ease; }
    .modal[aria-hidden="true"] { opacity: 0; pointer-events: none; }
    .modal[aria-hidden="false"] { opacity: 1; pointer-events: auto; }
    .modal .card { transform: translateY(-6px); transition: transform .18s ease, box-shadow .18s ease; }
    .modal[aria-hidden="false"] .card { transform: translateY(0); box-shadow: 0 8px 30px rgba(0,0,0,.18); }

    /* Spinner */
    .modal-spinner { width: 20px; height: 20px; border-radius: 50%; border: 3px solid rgba(0,0,0,0.08); border-top-color: var(--accent); animation: spin 800ms linear infinite; display:inline-block; vertical-align:middle; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Highlight updated row */
    .row-updated { animation: highlight 1800ms ease forwards; }
    @keyframes highlight { 0% { background: #d1fae5; } 60% { background: #fefce8; } 100% { background: transparent; } }

    .modal .field-error { color: #b91c1c; font-size: .9rem; margin-top: .25rem; }
    .modal .modal-errors { color: #b91c1c; font-size: .95rem; margin-bottom: .5rem; }

    .tablewrap mt-1{
      /* existing wrapper styles */
    }
    /* Column resizer handle (appears on right edge of th) */
    .preview-table th { position: relative; }
    .col-resizer {
      position: absolute;
      top: 0;
      right: 0;
      width: 10px; /* slightly larger hit area */
      cursor: col-resize;
      user-select: none;
      touch-action: none;
      height: 100%;
      z-index: 3;
      display: inline-block;
      background: transparent; /* keep transparent unless hovered */
      transition: background .12s ease;
      pointer-events: auto;
    }
    .preview-table th:hover > .col-resizer { background: linear-gradient(90deg, rgba(0,0,0,0), rgba(0,0,0,0.06)); }
    /* Make table cells wrap when narrow */
    .preview-table td { word-break: break-word; white-space: normal; }
    /* Transactions page: remove card shadow for page panels and use a solid divider under the toolbar */
    .card { box-shadow: none !important; border: 1px solid rgba(16,24,40,0.06) !important; }
    /* toolbar may not be a direct child (there may be an errors div) so match any descendant */
    .card .toolbar { border-bottom: 1px solid rgba(16,24,40,0.06); padding-bottom: .6rem; }
    /* restore modal shadows (more specific selector) so modal dialogs keep a shadow */
    .modal .card { box-shadow: 0 8px 30px rgba(0,0,0,.18) !important; }
  </style>
{% endblock %}

{% block content %}
  <h1>Transactions</h1>

  <div class="card">
    <div id="filter-errors" class="inline-errors" role="alert" aria-live="polite" style="display:none;margin-bottom:.5rem"></div>

    <!-- Search / filters toolbar -->
    <form method="get" class="toolbar" role="search" aria-label="Filter transactions" id="filters-form">

      <div class="field-group search-field">
        <label for="q" class="form-label sr-only">Search</label>
        <input id="q" class="form-input" type="text" name="q" placeholder="Search description or category" value="{{ q }}" style="color:var(--brand); background:#fff;" />
      </div>

      <div class="field-group start-field">
        <label for="start_date" class="sr-only">Start date</label>
        <input id="start_date" name="start_date" type="text" class="form-input form-date" value="{{ start_date }}" placeholder="Start date" style="color:var(--brand); background:#fff;" />
      </div>

      <div class="field-group end-field">
        <label for="end_date" class="sr-only">End date</label>
        <input id="end_date" name="end_date" type="text" class="form-input form-date" value="{{ end_date }}" placeholder="End date" style="color:var(--brand); background:#fff;" />
      </div>

      <div class="field-group dir-field">
        <label for="direction" class="form-label sr-only">Direction</label>
        <select id="direction" name="direction" class="form-select">
          {% if direction == 'inflow' %}
            <option value="">All</option>
            <option value="inflow" selected>Inflow</option>
            <option value="outflow">Outflow</option>
          {% elif direction == 'outflow' %}
            <option value="">All</option>
            <option value="inflow">Inflow</option>
            <option value="outflow" selected>Outflow</option>
          {% else %}
            <option value="" selected>All</option>
            <option value="inflow">Inflow</option>
            <option value="outflow">Outflow</option>
          {% endif %}
        </select>
      </div>

      <div class="field-group sort-field">
        <label for="sort" class="form-label sr-only">Sort</label>
        <select id="sort" name="sort" class="form-select">
          {% if sort == 'date' %}
            <option value="" >Date (default)</option>
            <option value="date" selected>Date ↑</option>
            <option value="-date">Date ↓</option>
            <option value="amount">Amount ↑</option>
            <option value="-amount">Amount ↓</option>
          {% elif sort == '-date' %}
            <option value="" >Date (default)</option>
            <option value="date">Date ↑</option>
            <option value="-date" selected>Date ↓</option>
            <option value="amount">Amount ↑</option>
            <option value="-amount">Amount ↓</option>
          {% elif sort == 'amount' %}
            <option value="" >Date (default)</option>
            <option value="date">Date ↑</option>
            <option value="-date">Date ↓</option>
            <option value="amount" selected>Amount ↑</option>
            <option value="-amount">Amount ↓</option>
          {% elif sort == '-amount' %}
            <option value="" >Date (default)</option>
            <option value="date">Date ↑</option>
            <option value="-date">Date ↓</option>
            <option value="amount">Amount ↑</option>
            <option value="-amount" selected>Amount ↓</option>
          {% else %}
            <option value="" selected>Date (default)</option>
            <option value="date">Date ↑</option>
            <option value="-date">Date ↓</option>
            <option value="amount">Amount ↑</option>
            <option value="-amount">Amount ↓</option>
          {% endif %}
        </select>
      </div>

      <!-- Actions at the end: Reset & Apply (compact) -->
      <div class="toolbar-actions" style="display:flex; gap:.5rem; align-items:center;">
        <button id="reset-filters" type="button" class="btn" aria-label="Reset filters">Reset Filters</button>
        <button class="btn btn-primary" type="submit">Apply</button>
      </div>

    </form>

    <!-- Secondary toolbar placed after the form so it appears under Reset/Apply and is right-aligned -->
    <div class="toolbar-secondary" style="display:flex; justify-content:flex-end;">
      {% if request.user.is_authenticated %}
        <button id="add-tx-btn" type="button" class="btn btn-primary">Add Transaction</button>
      {% endif %}
      <button id="columns-btn" type="button" class="btn" aria-haspopup="dialog">Columns</button>
      <button id="edit-selected" type="button" class="btn" disabled>Edit</button>
      <button id="delete-selected" type="button" class="btn" disabled>Delete</button>
    </div>


    <div class="tablewrap mt-1">
      <table class="preview-table">
        <thead>
          <tr>
            <th style="width:36px"><input id="select-all" type="checkbox" aria-label="Select all"></th>
            {% for col in columns %}
              {% if col == 'date' %}
                <th data-col="date" style="width:120px">{{ column_labels.date }}</th>
              {% elif col == 'description' %}
                <th data-col="description">{{ column_labels.description }}</th>
              {% elif col == 'category' %}
                <th data-col="category" style="width:180px">{{ column_labels.category }}</th>
              {% elif col == 'subcategory' %}
                <th data-col="subcategory">{{ column_labels.subcategory }}</th>
              {% elif col == 'amount' %}
                <th data-col="amount" style="text-align:right; width:140px">{{ column_labels.amount }}</th>
              {% elif col == 'direction' %}
                <th data-col="direction" style="width:120px">{{ column_labels.direction }}</th>
              {% elif col == 'account' %}
                <th data-col="account">{{ column_labels.account }}</th>
              {% elif col == 'source' %}
                <th data-col="source">{{ column_labels.source }}</th>
              {% elif col == 'created_at' %}
                <th data-col="created_at">{{ column_labels.created_at }}</th>
              {% elif col == 'updated_at' %}
                <th data-col="updated_at">{{ column_labels.updated_at }}</th>
              {% endif %}
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for t in page.object_list %}
            <tr>
              <td>
                <input class="row-select"
                       data-id="{{ t.id }}"
                       data-date="{{ t.date|date:'Y-m-d' }}"
                       data-description="{{ t.description|escape }}"
                       data-amount="{{ t.amount }}"
                       data-direction="{{ t.direction }}"
                       data-category="{{ t.category|escape }}"
                       data-subcategory="{{ t.subcategory|escape }}"
                       type="checkbox" aria-label="Select transaction {{ t.id }}">
              </td>
              {% for col in columns %}
                {% if col == 'date' %}
                  <td data-col="date">{{ t.date|date:"M. d, Y" }}</td>
                {% elif col == 'description' %}
                  <td data-col="description">{{ t.description }}</td>
                {% elif col == 'category' %}
                  <td data-col="category">{{ t.category }}</td>
                {% elif col == 'subcategory' %}
                  <td data-col="subcategory">{{ t.subcategory }}</td>
                {% elif col == 'amount' %}
                  <td data-col="amount" style="text-align:right">{{ t.amount }}</td>
                {% elif col == 'direction' %}
                  <td data-col="direction">{{ t.direction }}</td>
                {% elif col == 'account' %}
                  <td data-col="account">{{ t.account }}</td>
                {% elif col == 'source' %}
                  <td data-col="source">{{ t.source }}</td>
                {% elif col == 'created_at' %}
                  <td data-col="created_at">{{ t.created_at }}</td>
                {% elif col == 'updated_at' %}
                  <td data-col="updated_at">{{ t.updated_at }}</td>
                {% endif %}
              {% endfor %}
             </tr>
           {% empty %}
             <tr><td colspan="{{ columns|length|add:'1' }}">No transactions found.</td></tr>
           {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="mt-1 pagination-row">
      <div class="muted">
        Page {{ page.number }} of {{ page.paginator.num_pages }} — {{ page.paginator.count }} total
      </div>
      <div class="pagination">
        {% if page.has_previous %}
          <a class="btn" href="?page=1&{{ params }}">First</a>
          <a class="btn" href="?page={{ page.previous_page_number }}&{{ params }}">Previous</a>
        {% endif %}
        {% if page.has_next %}
          <a class="btn" href="?page={{ page.next_page_number }}&{{ params }}">Next</a>
          <a class="btn" href="?page={{ page.paginator.num_pages }}&{{ params }}">Last</a>
        {% endif %}
      </div>
    </div>

  </div>

  <!-- Delete confirmation modal (simple in-app modal) -->
  <div id="delete-modal" class="modal" role="dialog" aria-hidden="true" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); align-items:center; justify-content:center;">
    <div role="document" class="card" style="max-width:520px; margin:auto;">
      <div style="padding:1rem">
        <h2>Confirm deletion</h2>
        <p id="delete-modal-count"></p>
        <div style="display:flex; gap:.5rem;">
          <form id="delete-form" method="post" action="">
            {% csrf_token %}
            <input type="hidden" name="next" id="delete-next" value="{{ params }}">
            <input type="hidden" name="ids" id="delete-ids" value="">
            <button class="btn btn-primary" type="submit">Delete</button>
            <button id="delete-cancel" class="btn" type="button">Cancel</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Bulk Edit modal -->
   <div id="bulk-edit-modal" class="modal" role="dialog" aria-hidden="true" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); align-items:center; justify-content:center;">
     <div role="document" class="card" style="max-width:680px; margin:auto;">
       <div style="padding:1rem">
        <h2 id="bulk-edit-title">Bulk edit transactions</h2>
         <p id="bulk-edit-count"></p>
         <form id="bulk-edit-form" method="post" action="/transactions/bulk_edit/">
          {% csrf_token %}
          <input type="hidden" name="ids" id="bulk-edit-ids" value="">
          <input type="hidden" name="next" id="bulk-edit-next" value="{{ params }}">

          <div style="display:grid; grid-template-columns:1fr 1fr; gap:.75rem;">
            <div>
              <label for="bulk_date">Date (YYYY-MM-DD)</label>
              <input id="bulk_date" name="date" class="form-input form-date" placeholder="YYYY-MM-DD">
            </div>
            <div>
              <label for="bulk_amount">Amount</label>
              <input id="bulk_amount" name="amount" class="form-input" placeholder="Amount">
            </div>
            <div style="grid-column:1/-1">
              <label for="bulk_description">Description</label>
              <input id="bulk_description" name="description" class="form-input" placeholder="Description (applied to all if set)">
            </div>
            <div>
              <label for="bulk_direction">Direction</label>
              <select id="bulk_direction" name="direction" class="form-select">
                <option value="">(no change)</option>
                <option value="inflow">Inflow</option>
                <option value="outflow">Outflow</option>
              </select>
            </div>
            <div>
              <label for="bulk_category">Category</label>
              <input id="bulk_category" name="category" class="form-input" placeholder="Category">
            </div>
            <div>
              <label for="bulk_subcategory">Subcategory</label>
              <input id="bulk_subcategory" name="subcategory" class="form-input" placeholder="Subcategory">
            </div>
          </div>

          <div style="margin-top:1rem; display:flex; gap:.5rem; justify-content:flex-end;">
            <button id="bulk-edit-submit" class="btn btn-primary" type="submit">Apply changes <span id="bulk-spinner" style="display:none;margin-left:.5rem" aria-hidden="true"><span class="modal-spinner"></span></span></button>
            <button id="bulk-edit-cancel" class="btn" type="button">Cancel</button>
          </div>
         </form>
       </div>
     </div>
   </div>

  <!-- Columns modal -->
  <div id="columns-modal" class="modal" role="dialog" aria-hidden="true" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.35); align-items:center; justify-content:center;">
    <div role="document" class="card" style="max-width:520px; margin:auto;">
      <div style="padding:1rem">
        <h2>Choose columns</h2>
        <form id="columns-form">
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:.5rem; margin-top:.5rem;">
            {% for opt in all_columns %}
              <label style="display:flex; align-items:center; gap:.5rem;">
                {% if opt in columns %}
                  <input type="checkbox" name="columns" value="{{ opt }}" checked>
                {% else %}
                  <input type="checkbox" name="columns" value="{{ opt }}">
                {% endif %}
                {% if opt == 'date' %}Date{% elif opt == 'description' %}Description{% elif opt == 'category' %}Category{% elif opt == 'subcategory' %}Subcategory{% elif opt == 'amount' %}Amount{% elif opt == 'direction' %}Direction{% elif opt == 'account' %}Account{% elif opt == 'source' %}Source{% elif opt == 'created_at' %}Created{% elif opt == 'updated_at' %}Updated{% endif %}
              </label>
            {% endfor %}
          </div>
          <div style="display:flex; justify-content:flex-end; gap:.5rem; margin-top:1rem;">
            <button id="columns-save" type="button" class="btn btn-primary">Save</button>
            <button id="columns-cancel" type="button" class="btn">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- inline modal-level error container -->
  <div id="modal-global-error" class="modal-errors" style="display:none; margin: .5rem 0 0 0"></div>

  {% if request.user.is_authenticated %}
  <!-- Add Transaction modal (replaces the Add Transaction card from upload page) -->
  <div id="add-tx-modal" class="modal" role="dialog" aria-hidden="true" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.35); align-items:center; justify-content:center;">
    <div role="document" class="card" style="max-width:520px; margin:auto;">
      <div style="padding:1rem">
        <h2>Add Transaction</h2>
        <div id="add-modal-errors" class="inline-errors" role="alert" aria-live="polite" style="margin-bottom:.5rem; display:none"></div>
        <form id="add-tx-form-modal" method="post">
          {% csrf_token %}
          <input type="hidden" name="action" value="add_tx">
          <div class="form-row">
            <label class="form-label" for="add-tx-date">Date</label>
            <input id="add-tx-date" class="form-input" type="text" name="date" required />
          </div>

          <div class="form-row">
            <label class="form-label" for="add-tx-desc">Description</label>
            <input id="add-tx-desc" class="form-input" type="text" name="description" maxlength="512" required />
          </div>

          <div class="form-row" style="display:flex; gap:.75rem;">
            <div style="flex:1">
              <label class="form-label" for="add-tx-amount">Amount</label>
              <input id="add-tx-amount" class="form-input" type="text" name="amount" placeholder="e.g. 123.45" required />
            </div>

            <div style="width:160px;">
              <label class="form-label" for="add-tx-direction">Direction</label>
              <select id="add-tx-direction" class="form-select" name="direction">
                <option value="inflow">Inflow</option>
                <option value="outflow">Outflow</option>
              </select>
            </div>
          </div>

          <div class="form-row" style="display:flex; gap:.75rem;">
            <div style="flex:1">
              <label class="form-label" for="add-tx-category">Category</label>
              <input id="add-tx-category" class="form-input" type="text" name="category" />
            </div>
            <div style="flex:1">
              <label class="form-label" for="add-tx-subcategory">Subcategory</label>
              <input id="add-tx-subcategory" class="form-input" type="text" name="subcategory" />
            </div>
          </div>

          <div style="margin-top:1rem; display:flex; gap:.5rem; justify-content:flex-end;">
            <button id="add-tx-submit" class="btn btn-primary" type="submit">Add transaction</button>
            <button id="add-tx-cancel" class="btn" type="button">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Embed data as JSON (no inline executable JS) -->
  {{ columns|length|json_script:"table-data" }}

{% endblock %}

{% block scripts %}
<!--<script src="{% static 'app_web/dashboard.js' %}"></script>-->
<script src="{% static 'app_web/transactions.js' %}"></script>
   <script>
     // Initialize flatpickr on dashboard date inputs to match transactions styling & behavior
     (function(){
       document.addEventListener('DOMContentLoaded', function(){
         if(window.flatpickr){
           var opts = { dateFormat: 'Y-m-d', allowInput: true };
           flatpickr('#start_date', opts);
           flatpickr('#end_date', opts);
         }
       });
     })();
   </script>
  <!-- Fallback: attach essential button handlers if the main transactions.js didn't run -->
  <script>
    (function(){
      try{
        if(window._txFallbackInit) return; window._txFallbackInit = true;
        const $ = s => document.querySelector(s);
        const $$ = s => Array.from(document.querySelectorAll(s));
        const show = id => { const el = document.getElementById(id); if(el){ el.style.display='flex'; el.setAttribute('aria-hidden','false'); } };
        const hide = id => { const el = document.getElementById(id); if(el){ el.style.display='none'; el.setAttribute('aria-hidden','true'); } };
        const addBtn = $('#add-tx-btn'); if(addBtn) addBtn.addEventListener('click', ()=> show('add-tx-modal'));
        const addCancel = $('#add-tx-cancel'); if(addCancel) addCancel.addEventListener('click', ()=> hide('add-tx-modal'));
        const colsBtn = $('#columns-btn'); if(colsBtn) colsBtn.addEventListener('click', ()=> show('columns-modal'));
        const colsCancel = $('#columns-cancel'); if(colsCancel) colsCancel.addEventListener('click', ()=> hide('columns-modal'));
        const delBtn = $('#delete-selected'); if(delBtn) delBtn.addEventListener('click', ()=>{ const sel = $$('.row-select').filter(cb=>cb.checked).map(cb=>cb.dataset.id); if(!sel.length) return; const ids = $('#delete-ids'); const count = $('#delete-modal-count'); if(ids) ids.value = sel.join(','); if(count) count.textContent = sel.length + ' transactions will be deleted'; show('delete-modal'); });
        const delCancel = $('#delete-cancel'); if(delCancel) delCancel.addEventListener('click', ()=> hide('delete-modal'));
        const editBtn = $('#edit-selected'); if(editBtn) editBtn.addEventListener('click', ()=>{ const sel = $$('.row-select').filter(cb=>cb.checked).map(cb=>cb.dataset.id); if(!sel.length) return; const ids = $('#bulk-edit-ids'); const title = $('#bulk-edit-title'); if(ids) ids.value = sel.join(','); if(title) title.textContent = sel.length === 1 ? 'Edit transaction' : 'Bulk edit transactions'; show('bulk-edit-modal'); });
        const resetBtn = $('#reset-filters'); if(resetBtn) resetBtn.addEventListener('click', ()=>{ const f = $('#filters-form'); if(!f) return; Array.from(f.querySelectorAll('input[name], select[name]')).forEach(i=>{ if(i.name) i.value=''; }); f.submit(); });
      }catch(e){ console.error('transactions fallback init error', e); }
    })();
  </script>
{% endblock %}
