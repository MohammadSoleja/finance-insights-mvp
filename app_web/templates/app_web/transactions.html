{% extends "base.html" %}
{% load static %}
{% block title %}Transactions — Finance Insights{% endblock %}

{% block head_extra %}
  <!-- flatpickr for consistent date picker like Upload page -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <!-- Inline override styles (high specificity) to ensure toolbar is a single inline row and inputs share styling) -->
  <style>
     :root { --brand: #111827; --muted: #6b7280; }
     /* Responsive grid layout for toolbar (Actions | Search | Start | End | Direction | Sort) */
    .toolbar { display: grid !important; grid-auto-rows: auto !important;
               /* search | start | end | direction | sort | actions (actions last)
                  make start/end date columns smaller and slightly tighten spacing */
               grid-template-columns: minmax(160px,250px) 115px 115px 100px 130px auto !important;
               gap: .6rem !important; align-items: center !important; width:100%; max-width:100%; box-sizing:border-box; }
     .toolbar > * { margin: 0 !important; display: flex !important; align-items: center !important; }
     /* Make all toolbar controls the same height, padding and baseline so they align */
     .toolbar { align-items: center !important; }
     /* uniform sizing for precise alignment */
     .toolbar > * { min-height: 44px !important; display: inline-flex !important; align-items: center !important; }
     .toolbar .field-group { height: 44px !important; display: inline-flex !important; align-items: center !important; gap: .4rem !important; }
    /* allow controls to shrink and not force the grid to overflow; increase size for readability */
    /* Compact input sizing so toolbar fits comfortably */
    .toolbar .form-input, .toolbar .form-select, .toolbar .form-date { width: 100% !important; max-width: 100% !important; min-width: 0 !important; box-sizing: border-box !important; color: var(--brand) !important; font-size: 0.95rem !important; background: #fff !important; height: 40px !important; padding: 8px 10px !important; line-height: 1 !important; display: inline-flex !important; align-items: center !important; vertical-align: middle !important; border-radius: 6px !important; }
    /* ensure sr-only labels don't take space */
    .toolbar .field-group > label.sr-only { position: absolute !important; width: 1px !important; height: 1px !important; padding: 0 !important; margin: -1px !important; overflow: hidden !important; clip: rect(0 0 0 0) !important; border: 0 !important; }
    /* Ensure inner text vertically centers consistently across browsers */
    .toolbar .form-input::-webkit-input-placeholder, .toolbar .form-date::-webkit-input-placeholder { line-height: 1 !important; }
    .toolbar .form-input::-moz-placeholder, .toolbar .form-date::-moz-placeholder { line-height: 1 !important; }
    .toolbar .form-input:-ms-input-placeholder, .toolbar .form-date:-ms-input-placeholder { line-height: 1 !important; }
    .toolbar .form-input::placeholder, .toolbar .form-date::placeholder { line-height: 1 !important; }
    /* Remove any baseline shift and ensure consistent font metrics */
    .toolbar input, .toolbar select { font-family: inherit !important; font-size: 0.95rem !important; vertical-align: middle !important; box-sizing: border-box !important; }
     /* Keep default .btn sizing; only override the secondary toolbar buttons so they visually match Reset/Apply */
     .toolbar-secondary .btn {
       height: 40px !important;
       padding: 6px 12px !important;
       display: inline-flex !important;
       align-items: center !important;
       justify-content: center !important;
       border-radius: 6px !important;
       font-size: 0.95rem !important;
       box-sizing: border-box !important;
       width: auto !important; /* let width be content-based so it matches Reset/Apply */
     }
     /* Remove default margins from inputs/selects */
     .toolbar input, .toolbar select { margin: 0 !important; }
     .toolbar label { color: var(--muted) !important; }
    /* keep actions aligned to the end and give buttons spacing */
    .toolbar-actions { justify-self: end !important; display: flex !important; gap: .6rem !important; }
    /* Secondary toolbar (below filters) for columns/edit/delete; right-aligned under Reset/Apply */
    .toolbar-secondary { display:flex; gap:.5rem; align-items:center; margin-top:.5rem; justify-content:flex-end; }
    @media (max-width:900px){ .toolbar-secondary{ flex-wrap:wrap; gap:.5rem; } }
    @media (max-width:720px){ .toolbar-secondary{ grid-column:1/-1 !important; grid-row:auto !important; justify-self:flex-start !important; } }
     .toolbar * { align-self: center !important; }
     /* Ensure the visible text (values) inside the date inputs have the same color */
     .toolbar input, .toolbar select, .toolbar .flatpickr-input { color: var(--brand) !important; }
     /* Make placeholder/inactive text muted but consistent */
     .toolbar input::placeholder, .toolbar select::placeholder { color: var(--muted) !important; }
     /* On very small screens allow wrapping back to vertical flow */
     @media (max-width: 420px) { .toolbar { display:flex !important; flex-wrap:wrap !important; } }
     /* On small screens revert to stacked, but keep visual parity */
     @media (max-width: 900px) {
        /* switch to wrapped flex layout on narrower screens so items don't overflow */
        .toolbar { display: flex !important; flex-wrap: wrap !important; gap: .5rem !important; }
        .toolbar > * { flex: 0 0 auto !important; }
        .toolbar .field-group { flex: 1 1 48% !important; min-width: 140px !important; }
        .toolbar .dir-field, .toolbar .sort-field { flex: 0 0 48% !important; min-width: 120px !important; }
        .toolbar-actions { width: 100% !important; display:flex !important; justify-content:flex-end !important; }
      }
     /* Ensure flatpickr doesn't change input color */
     .flatpickr-input { color: var(--brand) !important; }

    /* Modal animation, spinner and row highlight */
    .modal { transition: opacity .18s ease; }
    .modal[aria-hidden="true"] { opacity: 0; pointer-events: none; }
    .modal[aria-hidden="false"] { opacity: 1; pointer-events: auto; }
    .modal .card { transform: translateY(-6px); transition: transform .18s ease, box-shadow .18s ease; }
    .modal[aria-hidden="false"] .card { transform: translateY(0); box-shadow: 0 8px 30px rgba(0,0,0,.18); }

    /* Spinner */
    .modal-spinner { width: 20px; height: 20px; border-radius: 50%; border: 3px solid rgba(0,0,0,0.08); border-top-color: var(--accent); animation: spin 800ms linear infinite; display:inline-block; vertical-align:middle; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Highlight updated row */
    .row-updated { animation: highlight 1800ms ease forwards; }
    @keyframes highlight { 0% { background: #d1fae5; } 60% { background: #fefce8; } 100% { background: transparent; } }

    .modal .field-error { color: #b91c1c; font-size: .9rem; margin-top: .25rem; }
    .modal .modal-errors { color: #b91c1c; font-size: .95rem; margin-bottom: .5rem; }
  </style>
{% endblock %}

{% block content %}
  <h1>Transactions</h1>

  <div class="card">
    <div id="filter-errors" class="inline-errors" role="alert" aria-live="polite" style="display:none;margin-bottom:.5rem"></div>

    <!-- Search / filters toolbar -->
    <form method="get" class="toolbar" role="search" aria-label="Filter transactions" id="filters-form">

      <div class="field-group search-field">
        <label for="q" class="form-label sr-only">Search</label>
        <input id="q" class="form-input" type="text" name="q" placeholder="Search description or category" value="{{ q }}" style="color:var(--brand); background:#fff;" />
      </div>

      <div class="field-group start-field">
        <label for="start_date" class="sr-only">Start date</label>
        <input id="start_date" name="start_date" type="text" class="form-input form-date" value="{{ start_date }}" placeholder="Start date" style="color:var(--brand); background:#fff;" />
      </div>

      <div class="field-group end-field">
        <label for="end_date" class="sr-only">End date</label>
        <input id="end_date" name="end_date" type="text" class="form-input form-date" value="{{ end_date }}" placeholder="End date" style="color:var(--brand); background:#fff;" />
      </div>

      <div class="field-group dir-field">
        <label for="direction" class="form-label sr-only">Direction</label>
        <select id="direction" name="direction" class="form-select">
          {% if direction == 'inflow' %}
            <option value="">All</option>
            <option value="inflow" selected>Inflow</option>
            <option value="outflow">Outflow</option>
          {% elif direction == 'outflow' %}
            <option value="">All</option>
            <option value="inflow">Inflow</option>
            <option value="outflow" selected>Outflow</option>
          {% else %}
            <option value="" selected>All</option>
            <option value="inflow">Inflow</option>
            <option value="outflow">Outflow</option>
          {% endif %}
        </select>
      </div>

      <div class="field-group sort-field">
        <label for="sort" class="form-label sr-only">Sort</label>
        <select id="sort" name="sort" class="form-select">
          {% if sort == 'date' %}
            <option value="" >Date (default)</option>
            <option value="date" selected>Date ↑</option>
            <option value="-date">Date ↓</option>
            <option value="amount">Amount ↑</option>
            <option value="-amount">Amount ↓</option>
          {% elif sort == '-date' %}
            <option value="" >Date (default)</option>
            <option value="date">Date ↑</option>
            <option value="-date" selected>Date ↓</option>
            <option value="amount">Amount ↑</option>
            <option value="-amount">Amount ↓</option>
          {% elif sort == 'amount' %}
            <option value="" >Date (default)</option>
            <option value="date">Date ↑</option>
            <option value="-date">Date ↓</option>
            <option value="amount" selected>Amount ↑</option>
            <option value="-amount">Amount ↓</option>
          {% elif sort == '-amount' %}
            <option value="" >Date (default)</option>
            <option value="date">Date ↑</option>
            <option value="-date">Date ↓</option>
            <option value="amount">Amount ↑</option>
            <option value="-amount" selected>Amount ↓</option>
          {% else %}
            <option value="" selected>Date (default)</option>
            <option value="date">Date ↑</option>
            <option value="-date">Date ↓</option>
            <option value="amount">Amount ↑</option>
            <option value="-amount">Amount ↓</option>
          {% endif %}
        </select>
      </div>

      <!-- Actions at the end: Reset & Apply (compact) -->
      <div class="toolbar-actions" style="display:flex; gap:.5rem; align-items:center;">
        <button id="reset-filters" type="button" class="btn" aria-label="Reset filters">Reset Filters</button>
        <button class="btn btn-primary" type="submit">Apply</button>
      </div>

    </form>

    <!-- Secondary toolbar placed after the form so it appears under Reset/Apply and is right-aligned -->
    <div class="toolbar-secondary" style="display:flex; justify-content:flex-end;">
      {% if request.user.is_authenticated %}
        <button id="add-tx-btn" type="button" class="btn btn-primary">Add Transaction</button>
      {% endif %}
      <button id="columns-btn" type="button" class="btn" aria-haspopup="dialog">Columns</button>
      <button id="edit-selected" type="button" class="btn" disabled>Edit</button>
      <button id="delete-selected" type="button" class="btn" disabled>Delete</button>
    </div>


    <div class="tablewrap mt-1">
      <table class="preview-table">
        <thead>
          <tr>
            <th style="width:36px"><input id="select-all" type="checkbox" aria-label="Select all"></th>
            {% for col in columns %}
              {% if col == 'date' %}
                <th data-col="date" style="width:120px">{{ column_labels.date }}</th>
              {% elif col == 'description' %}
                <th data-col="description">{{ column_labels.description }}</th>
              {% elif col == 'category' %}
                <th data-col="category" style="width:180px">{{ column_labels.category }}</th>
              {% elif col == 'subcategory' %}
                <th data-col="subcategory">{{ column_labels.subcategory }}</th>
              {% elif col == 'amount' %}
                <th data-col="amount" style="text-align:right; width:140px">{{ column_labels.amount }}</th>
              {% elif col == 'direction' %}
                <th data-col="direction" style="width:120px">{{ column_labels.direction }}</th>
              {% elif col == 'account' %}
                <th data-col="account">{{ column_labels.account }}</th>
              {% elif col == 'source' %}
                <th data-col="source">{{ column_labels.source }}</th>
              {% elif col == 'created_at' %}
                <th data-col="created_at">{{ column_labels.created_at }}</th>
              {% elif col == 'updated_at' %}
                <th data-col="updated_at">{{ column_labels.updated_at }}</th>
              {% endif %}
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for t in page.object_list %}
            <tr>
              <td>
                <input class="row-select"
                       data-id="{{ t.id }}"
                       data-date="{{ t.date|date:'Y-m-d' }}"
                       data-description="{{ t.description|escape }}"
                       data-amount="{{ t.amount }}"
                       data-direction="{{ t.direction }}"
                       data-category="{{ t.category|escape }}"
                       data-subcategory="{{ t.subcategory|escape }}"
                       type="checkbox" aria-label="Select transaction {{ t.id }}">
              </td>
              {% for col in columns %}
                {% if col == 'date' %}
                  <td data-col="date">{{ t.date|date:"M. d, Y" }}</td>
                {% elif col == 'description' %}
                  <td data-col="description">{{ t.description }}</td>
                {% elif col == 'category' %}
                  <td data-col="category">{{ t.category }}</td>
                {% elif col == 'subcategory' %}
                  <td data-col="subcategory">{{ t.subcategory }}</td>
                {% elif col == 'amount' %}
                  <td data-col="amount" style="text-align:right">{{ t.amount }}</td>
                {% elif col == 'direction' %}
                  <td data-col="direction">{{ t.direction }}</td>
                {% elif col == 'account' %}
                  <td data-col="account">{{ t.account }}</td>
                {% elif col == 'source' %}
                  <td data-col="source">{{ t.source }}</td>
                {% elif col == 'created_at' %}
                  <td data-col="created_at">{{ t.created_at }}</td>
                {% elif col == 'updated_at' %}
                  <td data-col="updated_at">{{ t.updated_at }}</td>
                {% endif %}
              {% endfor %}
             </tr>
           {% empty %}
             <tr><td colspan="{{ columns|length|add:'1' }}">No transactions found.</td></tr>
           {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="mt-1 pagination-row">
      <div class="muted">
        Page {{ page.number }} of {{ page.paginator.num_pages }} — {{ page.paginator.count }} total
      </div>
      <div class="pagination">
        {% if page.has_previous %}
          <a class="btn" href="?page=1&{{ params }}">First</a>
          <a class="btn" href="?page={{ page.previous_page_number }}&{{ params }}">Previous</a>
        {% endif %}
        {% if page.has_next %}
          <a class="btn" href="?page={{ page.next_page_number }}&{{ params }}">Next</a>
          <a class="btn" href="?page={{ page.paginator.num_pages }}&{{ params }}">Last</a>
        {% endif %}
      </div>
    </div>

  </div>

  <!-- Delete confirmation modal (simple in-app modal) -->
  <div id="delete-modal" class="modal" role="dialog" aria-hidden="true" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); align-items:center; justify-content:center;">
    <div role="document" class="card" style="max-width:520px; margin:auto;">
      <div style="padding:1rem">
        <h2>Confirm deletion</h2>
        <p id="delete-modal-count"></p>
        <div style="display:flex; gap:.5rem;">
          <form id="delete-form" method="post" action="">
            {% csrf_token %}
            <input type="hidden" name="next" id="delete-next" value="{{ params }}">
            <input type="hidden" name="ids" id="delete-ids" value="">
            <button class="btn btn-primary" type="submit">Delete</button>
            <button id="delete-cancel" class="btn" type="button">Cancel</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Bulk Edit modal -->
   <div id="bulk-edit-modal" class="modal" role="dialog" aria-hidden="true" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); align-items:center; justify-content:center;">
     <div role="document" class="card" style="max-width:680px; margin:auto;">
       <div style="padding:1rem">
        <h2 id="bulk-edit-title">Bulk edit transactions</h2>
         <p id="bulk-edit-count"></p>
         <form id="bulk-edit-form" method="post" action="/transactions/bulk_edit/">
          {% csrf_token %}
          <input type="hidden" name="ids" id="bulk-edit-ids" value="">
          <input type="hidden" name="next" id="bulk-edit-next" value="{{ params }}">

          <div style="display:grid; grid-template-columns:1fr 1fr; gap:.75rem;">
            <div>
              <label for="bulk_date">Date (YYYY-MM-DD)</label>
              <input id="bulk_date" name="date" class="form-input form-date" placeholder="YYYY-MM-DD">
            </div>
            <div>
              <label for="bulk_amount">Amount</label>
              <input id="bulk_amount" name="amount" class="form-input" placeholder="Amount">
            </div>
            <div style="grid-column:1/-1">
              <label for="bulk_description">Description</label>
              <input id="bulk_description" name="description" class="form-input" placeholder="Description (applied to all if set)">
            </div>
            <div>
              <label for="bulk_direction">Direction</label>
              <select id="bulk_direction" name="direction" class="form-select">
                <option value="">(no change)</option>
                <option value="inflow">Inflow</option>
                <option value="outflow">Outflow</option>
              </select>
            </div>
            <div>
              <label for="bulk_category">Category</label>
              <input id="bulk_category" name="category" class="form-input" placeholder="Category">
            </div>
            <div>
              <label for="bulk_subcategory">Subcategory</label>
              <input id="bulk_subcategory" name="subcategory" class="form-input" placeholder="Subcategory">
            </div>
          </div>

          <div style="margin-top:1rem; display:flex; gap:.5rem; justify-content:flex-end;">
            <button id="bulk-edit-submit" class="btn btn-primary" type="submit">Apply changes <span id="bulk-spinner" style="display:none;margin-left:.5rem" aria-hidden="true"><span class="modal-spinner"></span></span></button>
            <button id="bulk-edit-cancel" class="btn" type="button">Cancel</button>
          </div>
         </form>
       </div>
     </div>
   </div>

  <!-- Columns modal -->
  <div id="columns-modal" class="modal" role="dialog" aria-hidden="true" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.35); align-items:center; justify-content:center;">
    <div role="document" class="card" style="max-width:520px; margin:auto;">
      <div style="padding:1rem">
        <h2>Choose columns</h2>
        <form id="columns-form">
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:.5rem; margin-top:.5rem;">
            {% for opt in all_columns %}
              <label style="display:flex; align-items:center; gap:.5rem;">
                {% if opt in columns %}
                  <input type="checkbox" name="columns" value="{{ opt }}" checked>
                {% else %}
                  <input type="checkbox" name="columns" value="{{ opt }}">
                {% endif %}
                {% if opt == 'date' %}Date{% elif opt == 'description' %}Description{% elif opt == 'category' %}Category{% elif opt == 'subcategory' %}Subcategory{% elif opt == 'amount' %}Amount{% elif opt == 'direction' %}Direction{% elif opt == 'account' %}Account{% elif opt == 'source' %}Source{% elif opt == 'created_at' %}Created{% elif opt == 'updated_at' %}Updated{% endif %}
              </label>
            {% endfor %}
          </div>
          <div style="display:flex; justify-content:flex-end; gap:.5rem; margin-top:1rem;">
            <button id="columns-save" type="button" class="btn btn-primary">Save</button>
            <button id="columns-cancel" type="button" class="btn">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- inline modal-level error container -->
  <div id="modal-global-error" class="modal-errors" style="display:none; margin: .5rem 0 0 0"></div>

  {% if request.user.is_authenticated %}
  <!-- Add Transaction modal (replaces the Add Transaction card from upload page) -->
  <div id="add-tx-modal" class="modal" role="dialog" aria-hidden="true" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.35); align-items:center; justify-content:center;">
    <div role="document" class="card" style="max-width:520px; margin:auto;">
      <div style="padding:1rem">
        <h2>Add Transaction</h2>
        <div id="add-modal-errors" class="inline-errors" role="alert" aria-live="polite" style="margin-bottom:.5rem; display:none"></div>
        <form id="add-tx-form-modal" method="post">
          {% csrf_token %}
          <input type="hidden" name="action" value="add_tx">
          <div class="form-row">
            <label class="form-label" for="add-tx-date">Date</label>
            <input id="add-tx-date" class="form-input" type="text" name="date" required />
          </div>

          <div class="form-row">
            <label class="form-label" for="add-tx-desc">Description</label>
            <input id="add-tx-desc" class="form-input" type="text" name="description" maxlength="512" required />
          </div>

          <div class="form-row" style="display:flex; gap:.75rem;">
            <div style="flex:1">
              <label class="form-label" for="add-tx-amount">Amount</label>
              <input id="add-tx-amount" class="form-input" type="text" name="amount" placeholder="e.g. 123.45" required />
            </div>

            <div style="width:160px;">
              <label class="form-label" for="add-tx-direction">Direction</label>
              <select id="add-tx-direction" class="form-select" name="direction">
                <option value="inflow">Inflow</option>
                <option value="outflow">Outflow</option>
              </select>
            </div>
          </div>

          <div class="form-row" style="display:flex; gap:.75rem;">
            <div style="flex:1">
              <label class="form-label" for="add-tx-category">Category</label>
              <input id="add-tx-category" class="form-input" type="text" name="category" />
            </div>
            <div style="flex:1">
              <label class="form-label" for="add-tx-subcategory">Subcategory</label>
              <input id="add-tx-subcategory" class="form-input" type="text" name="subcategory" />
            </div>
          </div>

          <div style="margin-top:1rem; display:flex; gap:.5rem; justify-content:flex-end;">
            <button id="add-tx-submit" class="btn btn-primary" type="submit">Add transaction</button>
            <button id="add-tx-cancel" class="btn" type="button">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  {% endif %}

{% endblock %}

{% block scripts %}
<script>
  (function(){
    if(window.flatpickr){
      // initialize flatpickr like upload page; use ISO format
      const opts = { dateFormat: 'Y-m-d', allowInput: true };
      flatpickr('#start_date', opts);
      flatpickr('#end_date', opts);
      // modal date for bulk/single edit
      flatpickr('#bulk_date', opts);
      // modal date for add transaction
      flatpickr('#add-tx-date', opts);

      const form = document.getElementById('filters-form');
      const startInput = document.getElementById('start_date');
      const endInput = document.getElementById('end_date');
      const errorsEl = document.getElementById('filter-errors');
      const resetBtn = document.getElementById('reset-filters');

      function validateDates(){
        if(!errorsEl) return true;
        errorsEl.style.display = 'none';
        errorsEl.textContent = '';
        const s = startInput && startInput.value && startInput.value.trim();
        const e = endInput && endInput.value && endInput.value.trim();
        if(!s && !e) return true;
        function toDate(val){ if(!val) return null; const t = Date.parse(val); return isNaN(t) ? null : new Date(t); }
        const sd = toDate(s);
        const ed = toDate(e);
        if(s && !sd){ errorsEl.style.display='block'; errorsEl.textContent='Start date is invalid (use YYYY-MM-DD)'; return false; }
        if(e && !ed){ errorsEl.style.display='block'; errorsEl.textContent='End date is invalid (use YYYY-MM-DD)'; return false; }
        if(sd && ed && sd > ed){ errorsEl.style.display='block'; errorsEl.textContent='Start date must be before or equal to end date'; return false; }
        return true;
      }

      if(startInput){ startInput.addEventListener('change', validateDates); startInput.addEventListener('blur', validateDates); }
      if(endInput){ endInput.addEventListener('change', validateDates); endInput.addEventListener('blur', validateDates); }

      // Reset button clears query params (navigate to base path)
      if(resetBtn){ resetBtn.addEventListener('click', function(){
         // if you want to preserve anchor/hash you can keep it; for now navigate to base path
         window.location = window.location.pathname;
      }); }

      // prevent submit if invalid
      if(form){ form.addEventListener('submit', function(e){ if(!validateDates()){ e.preventDefault(); if(startInput) startInput.focus(); } }); }

      // runtime toolbar layout toggle (grid on desktop, flex on small screens)
      function debounce(fn, wait){ let t; return function(){ clearTimeout(t); t = setTimeout(()=>fn.apply(this, arguments), wait); }; }
      function updateToolbarLayout(){
        const tb = document.getElementById('filters-form');
        if(!tb) return;
        const w = window.innerWidth || document.documentElement.clientWidth;
        if(w >= 720){
          tb.style.display = 'grid';
          tb.style.gridTemplateColumns = 'minmax(160px,360px) 110px 110px 120px 120px auto';
          tb.style.gap = '.6rem';
          tb.style.alignItems = 'center';
        } else {
          tb.style.display = 'flex';
          tb.style.flexWrap = 'wrap';
          tb.style.gap = '0.5rem';
        }
        // ensure inputs/selects have consistent text color and background
        const els = tb.querySelectorAll('input, select');
        els.forEach(el=>{
          el.style.color = getComputedStyle(document.documentElement).getPropertyValue('--brand') || '#111827';
          el.style.background = '#fff';
          el.style.boxSizing = 'border-box';
        });
      }
      const onResize = debounce(updateToolbarLayout, 120);
      window.addEventListener('resize', onResize);
      // initial layout set
      updateToolbarLayout();
    }
  })();
</script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  // selection helpers for transactions table
  const selectAll = document.getElementById('select-all');
  // querySelectorAll at runtime so it reflects current DOM
  function rowSelects(){ return Array.from(document.querySelectorAll('.row-select')); }
  const editBtn = document.getElementById('edit-selected');
  const deleteBtn = document.getElementById('delete-selected');
  const deleteModal = document.getElementById('delete-modal');
  const deleteForm = document.getElementById('delete-form');
  const deleteIdsInput = document.getElementById('delete-ids');
  const deleteModalCount = document.getElementById('delete-modal-count');
  const deleteNext = document.getElementById('delete-next');

  // Ensure buttons are clickable (defensive CSS via style)
  if(editBtn){ editBtn.style.pointerEvents = 'auto'; editBtn.removeAttribute('disabled'); }
  if(deleteBtn){ deleteBtn.style.pointerEvents = 'auto'; deleteBtn.removeAttribute('disabled'); }

  function selectedIds(){ return Array.from(document.querySelectorAll('.row-select:checked')).map(el=>el.dataset.id); }
  function updateButtons(){
    try{
      const ids = selectedIds();
      const ok = ids && ids.length > 0;
      if(editBtn){ editBtn.setAttribute('aria-disabled', !ok ? 'true' : 'false'); editBtn.classList.toggle('disabled', !ok); }
      if(deleteBtn){ deleteBtn.setAttribute('aria-disabled', !ok ? 'true' : 'false'); deleteBtn.classList.toggle('disabled', !ok); }
    }catch(err){ console.error('updateButtons error', err); }
  }
  // expose for other scripts
  window.updateButtons = updateButtons;

  // Attach change handlers to dynamically reflect row selects
  function attachRowListeners(){
    rowSelects().forEach(cb => {
      cb.removeEventListener('change', updateButtons);
      cb.addEventListener('change', updateButtons);
    });
  }

  if(selectAll){
    selectAll.addEventListener('change', function(){
      const checked = selectAll.checked;
      document.querySelectorAll('.row-select').forEach(cb=>cb.checked=checked);
      updateButtons();
    });
  }

  // Initial attach & state
  attachRowListeners();
  updateButtons();

  // Re-attach if DOM changes (simple mutation observer to catch re-rendered table rows)
  try{
    const tableWrap = document.querySelector('.tablewrap');
    if(tableWrap){
      const mo = new MutationObserver(function(){ attachRowListeners(); updateButtons(); });
      mo.observe(tableWrap, { childList: true, subtree: true });
    }
  }catch(e){ /* non-fatal */ }

  // Edit button behavior
  if(editBtn){
    editBtn.addEventListener('click', function(e){
      console.log('Edit clicked');
      const ids = selectedIds();
      if(!ids || ids.length === 0) { console.warn('Edit clicked with no selection'); return; }
       const modal = document.getElementById('bulk-edit-modal');
      const form = document.getElementById('bulk-edit-form');
      const idsInput = document.getElementById('bulk-edit-ids');
      const countEl = document.getElementById('bulk-edit-count');
      const titleEl = document.getElementById('bulk-edit-title');

      if(ids.length === 1){
        const cb = document.querySelector('.row-select[data-id="'+ids[0]+'"]');
        if(!cb) return;
        // ensure date is ISO (YYYY-MM-DD) and amount is numeric without currency symbols
        document.getElementById('bulk_date').value = cb.dataset.date || '';
        (function(){
          const rawAmount = cb.dataset.amount || '';
          const sanitized = (rawAmount+"").replace(/[^0-9.\-]+/g, '');
          document.getElementById('bulk_amount').value = sanitized;
        })();
        document.getElementById('bulk_description').value = cb.dataset.description || '';
        document.getElementById('bulk_direction').value = cb.dataset.direction || '';
        document.getElementById('bulk_category').value = cb.dataset.category || '';
        document.getElementById('bulk_subcategory').value = cb.dataset.subcategory || '';
        idsInput.value = ids.join(',');
        form.action = '/transactions/'+ids[0]+'/edit/';
        titleEl.textContent = 'Edit transaction';
        countEl.textContent = '';
        if(modal){ modal.style.display='flex'; modal.setAttribute('aria-hidden','false'); }
        return;
      }

      // multiple
      document.getElementById('bulk_date').value = '';
      document.getElementById('bulk_amount').value = '';
      document.getElementById('bulk_description').value = '';
      document.getElementById('bulk_direction').value = '';
      document.getElementById('bulk_category').value = '';
      document.getElementById('bulk_subcategory').value = '';
      idsInput.value = ids.join(',');
      form.action = '/transactions/bulk_edit/';
      titleEl.textContent = 'Bulk edit transactions';
      countEl.textContent = 'You are about to edit '+ids.length+' transactions. Only fields you fill will be applied to all selected.';
      if(modal){ modal.style.display='flex'; modal.setAttribute('aria-hidden','false'); }
    });
  }

  // Delete button behavior
  if(deleteBtn){
    deleteBtn.addEventListener('click', function(){
      console.log('Delete clicked');
      const ids = selectedIds();
      if(!ids || ids.length === 0){ console.warn('Delete clicked with no selection'); return; }
       if(deleteModal){ deleteModal.style.display='flex'; deleteModal.setAttribute('aria-hidden','false'); }
      if(deleteIdsInput) deleteIdsInput.value = ids.join(',');
      if(deleteModalCount) deleteModalCount.textContent = 'You are about to delete '+ids.length+' transaction(s). This cannot be undone.';
      if(deleteForm) deleteForm.action = '/transactions/'+ids[0]+'/delete/';
    });
  }

  // Delete form submit handling preserved (keeps previous logic)
  if(deleteForm){
    deleteForm.addEventListener('submit', function(e){
      const ids = deleteIdsInput.value ? deleteIdsInput.value.split(',') : [];
      if(ids.length <= 1) return; // normal POST for single
      e.preventDefault();
      const next = deleteNext.value || '';
      (async function(){
        // read CSRF token from page form or cookie
        function getCookie(name){ const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)'); return v ? v.pop() : ''; }
        const pageCsrf = (document.querySelector('input[name=csrfmiddlewaretoken]') && document.querySelector('input[name=csrfmiddlewaretoken]').value) ? document.querySelector('input[name=csrfmiddlewaretoken]').value : getCookie('csrftoken');
        for(const id of ids){
          const formData = new FormData();
          formData.append('csrfmiddlewaretoken', pageCsrf);
          formData.append('next', next);
          try{ await fetch('/transactions/'+id+'/delete/', { method:'POST', body: formData, credentials:'same-origin', headers: {'X-CSRFToken': pageCsrf} }); }catch(err){ console.error(err); }
        }
        window.location = '/transactions/'+(next ? '?'+next : '');
      })();
    });
  }

  // Columns modal behavior
  const columnsBtn = document.getElementById('columns-btn');
  const columnsModal = document.getElementById('columns-modal');
  const columnsForm = document.getElementById('columns-form');
  const columnsSave = document.getElementById('columns-save');
  const columnsCancel = document.getElementById('columns-cancel');

  function getCookie(name){ const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)'); return v ? v.pop() : ''; }

  if(columnsBtn){
    columnsBtn.addEventListener('click', function(){
      if(columnsModal){ columnsModal.style.display='flex'; columnsModal.setAttribute('aria-hidden','false'); }
    });
  }
  if(columnsCancel){ columnsCancel.addEventListener('click', function(){ if(columnsModal){ columnsModal.style.display='none'; columnsModal.setAttribute('aria-hidden','true'); } }); }

  if(columnsSave){
    columnsSave.addEventListener('click', async function(){
      // collect selected columns in DOM order
      const boxes = Array.from(columnsForm.querySelectorAll('input[name="columns"]'));
      const selected = boxes.filter(b=>b.checked).map(b=>b.value);
      if(selected.length === 0){ alert('Please select at least one column'); return; }
      // POST JSON to server
      try{
        const csrftoken = getCookie('csrftoken');
        const resp = await fetch('/transactions/columns/', {
          method: 'POST',
          credentials: 'same-origin',
          headers: {'Content-Type':'application/json', 'X-CSRFToken': csrftoken},
          body: JSON.stringify({columns: selected})
        });
        const data = await resp.json().catch(()=>null);
        if(!resp.ok){
          alert((data && data.error) ? data.error : 'Failed to save columns');
          return;
        }
        // success: reload page so server renders the new order/visibility
        window.location.reload();
      }catch(err){ console.error(err); alert('Network error while saving columns'); }
    });
  }

  // Add Transaction modal behavior
  const addTxBtn = document.getElementById('add-tx-btn');
  const addTxModal = document.getElementById('add-tx-modal');
  const addTxForm = document.getElementById('add-tx-form-modal');
  const addTxCancel = document.getElementById('add-tx-cancel');

  // Build a JS array of visible columns so the client can insert a new row matching server columns
  const TRANSACTION_COLUMNS = [{% for c in columns %}'{{ c }}'{% if not forloop.last %}, {% endif %}{% endfor %}];

  // small helper to format ISO date to 'Mon. d, YYYY' like server template
  function formatDateReadable(iso){
    try{
      const d = new Date(iso);
      if(isNaN(d)) return iso;
      const months = ['Jan.', 'Feb.', 'Mar.', 'Apr.', 'May', 'Jun.', 'Jul.', 'Aug.', 'Sep.', 'Oct.', 'Nov.', 'Dec.'];
      return months[d.getMonth()] + ' ' + d.getDate() + ', ' + d.getFullYear();
    }catch(e){ return iso; }
  }

  if(addTxBtn){
    addTxBtn.addEventListener('click', function(){
      if(addTxModal){ addTxModal.style.display='flex'; addTxModal.setAttribute('aria-hidden','false'); }
    });
  }
  if(addTxCancel){
    addTxCancel.addEventListener('click', function(){
      if(addTxModal){ addTxModal.style.display='none'; addTxModal.setAttribute('aria-hidden','true'); }
    });
  }

  // AJAX submit handler for Add Transaction modal
  // Add Transaction modal submit handler (simplified)
  if(document.getElementById('add-tx-form-modal')){
    (function(){
      const modalForm = document.getElementById('add-tx-form-modal');
      const modalEl = document.getElementById('add-tx-modal');
      modalForm.addEventListener('submit', async function(e){
        e.preventDefault();
        const fd = new FormData(modalForm);
        fd.set('action','add_tx');
        const csrftoken = (modalForm.querySelector('input[name=csrfmiddlewaretoken]') && modalForm.querySelector('input[name=csrfmiddlewaretoken]').value) || (function(){ const m = document.cookie.match('(^|;)\\s*csrftoken\\s*=\\s*([^;]+)'); return m ? m.pop() : ''; })();
        try{
          const resp = await fetch(window.location.pathname, { method: 'POST', body: fd, credentials: 'same-origin', headers: {'X-CSRFToken': csrftoken, 'X-Requested-With':'XMLHttpRequest'} });
          let data = null;
          try{ data = await resp.json(); }catch(e){ data = null; }
          if(resp.ok && data && data.ok){
            if(modalEl){ modalEl.style.display='none'; modalEl.setAttribute('aria-hidden','true'); }
            try{ modalForm.reset(); if(window.flatpickr){ const f = document.querySelector('#add-tx-date'); if(f && f._flatpickr) f._flatpickr.clear(); } }catch(_){ }

            // Insert the newly created transaction into the table (top of tbody)
            try{
              const tx = data.tx;
              const tbody = document.querySelector('.tablewrap tbody');
              if(tbody){
                // remove "No transactions found" row if present
                const firstRow = tbody.querySelector('tr');
                if(firstRow && firstRow.children.length === 1 && firstRow.textContent && firstRow.textContent.trim().startsWith('No transactions')){
                  firstRow.remove();
                }

                const tr = document.createElement('tr');
                // checkbox cell
                const td0 = document.createElement('td');
                const cb = document.createElement('input');
                cb.type = 'checkbox'; cb.className = 'row-select';
                cb.setAttribute('data-id', tx.id);
                cb.setAttribute('data-date', tx.date || '');
                cb.setAttribute('data-description', tx.description || '');
                cb.setAttribute('data-amount', tx.amount || '');
                cb.setAttribute('data-direction', tx.direction || '');
                cb.setAttribute('data-category', tx.category || '');
                cb.setAttribute('data-subcategory', tx.subcategory || '');
                td0.appendChild(cb);
                tr.appendChild(td0);

                // append cells for each visible column in order
                TRANSACTION_COLUMNS.forEach(function(col){
                  const td = document.createElement('td');
                  td.setAttribute('data-col', col);
                  if(col === 'date'){
                    td.textContent = formatDateReadable(tx.date || '');
                  } else if(col === 'amount'){
                    td.style.textAlign = 'right';
                    td.textContent = tx.amount || '';
                  } else if(col === 'direction'){
                    td.textContent = tx.direction || '';
                  } else if(col === 'description'){
                    td.textContent = tx.description || '';
                  } else if(col === 'category'){
                    td.textContent = tx.category || '';
                  } else if(col === 'subcategory'){
                    td.textContent = tx.subcategory || '';
                  } else if(col === 'account'){
                    td.textContent = tx.account || '';
                  } else if(col === 'source'){
                    td.textContent = tx.source || '';
                  } else if(col === 'created_at'){
                    td.textContent = tx.created_at || '';
                  } else if(col === 'updated_at'){
                    td.textContent = tx.updated_at || '';
                  } else {
                    td.textContent = tx[col] || '';
                  }
                  tr.appendChild(td);
                });

                // prepend the row
                tbody.insertBefore(tr, tbody.firstChild);
                // attach listeners and update buttons
                try{ if(window.updateButtons) window.updateButtons(); }catch(e){}
                try{ if(typeof attachRowListeners === 'function') attachRowListeners(); }catch(e){}

                // update total count shown in pagination row (simple increment)
                try{
                  const totalEl = document.querySelector('.pagination-row .muted');
                  if(totalEl){
                    const txt = totalEl.textContent || '';
                    const m = txt.match(/—\s*([0-9,]+)\s*total/);
                    if(m){
                      const cur = parseInt(m[1].replace(/,/g,''), 10) || 0;
                      const next = (cur + 1).toLocaleString();
                      totalEl.textContent = txt.replace(m[1], next);
                    }
                  }
                }catch(e){}
              }
            }catch(e){ console.error('Failed to insert new transaction row', e); }

            const banner = document.createElement('div'); banner.className='card'; banner.style.padding='.6rem'; banner.style.margin='.6rem 0'; banner.textContent='Transaction added';
            const main = document.querySelector('main') || document.body; if(main && main.insertBefore) main.insertBefore(banner, main.firstChild);
            setTimeout(()=>{ if(banner && banner.remove) banner.remove(); }, 2000);
          } else {
            const errEl = document.getElementById('add-modal-errors');
            let errs = (data && data.errors) || null;
            // if server returned non-JSON (e.g. CSRF HTML or template), show text for debugging
            if(!errs){
              try{
                const txt = await resp.text();
                // If it's HTML (CSRF page), show a brief hint + raw text in a <pre>
                if(resp.status === 403){ errs = ['Permission denied (CSRF token missing or invalid). Please refresh the page and try again.']; }
                else { errs = [ (txt && txt.length>0) ? txt.substring(0,800) : 'Failed to add transaction' ]; }
              }catch(e){ errs = ['Failed to add transaction']; }
            }
            if(errEl){ errEl.style.display='block'; errEl.innerHTML = '<ul>'+errs.map(x=>'<li>'+x+'</li>').join('')+'</ul>'; }
          }
        }catch(err){ console.error(err); const errEl = document.getElementById('add-modal-errors'); if(errEl){ errEl.style.display='block'; errEl.textContent='Network error'; } }
      });
    })();
  }

  // modal cancel buttons: close modals
    const bulkCancelBtn = document.getElementById('bulk-edit-cancel');
    if(bulkCancelBtn){ bulkCancelBtn.addEventListener('click', function(){ const m = document.getElementById('bulk-edit-modal'); if(m){ m.style.display='none'; m.setAttribute('aria-hidden','true'); } }); }
    const deleteCancelBtn = document.getElementById('delete-cancel');
    if(deleteCancelBtn){ deleteCancelBtn.addEventListener('click', function(){ const m = document.getElementById('delete-modal'); if(m){ m.style.display='none'; m.setAttribute('aria-hidden','true'); } }); }
    const addTxCancelBtn = document.getElementById('add-tx-cancel');
    if(addTxCancelBtn){ addTxCancelBtn.addEventListener('click', function(){ const m = document.getElementById('add-tx-modal'); if(m){ m.style.display='none'; m.setAttribute('aria-hidden','true'); } }); }

    // Initial button state (in case rows are pre-selected by the browser or other script)
    try{ if(window.updateButtons) window.updateButtons(); }catch(e){ /* ignore */ }
  });
</script>

<!-- Equal-size buttons for secondary toolbar (responsive tweak) -->
<style>
  .toolbar-secondary .btn { text-align: center !important; }
  @media (max-width:600px){ .toolbar-secondary .btn{ min-width: 92px !important; } }
</style>

{% endblock %}
