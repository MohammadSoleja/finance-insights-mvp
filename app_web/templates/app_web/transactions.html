{% extends "base.html" %}
{% load static %}
{% block title %}Transactions — Finance Insights{% endblock %}

{% block head_extra %}
<!-- flatpickr for consistent date picker -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<!-- Transactions Styles -->
<link rel="stylesheet" href="{% static 'app_web/transactions.css' %}">
{% endblock %}

{% block content %}

  <div class="card">
    <div id="filter-errors" class="inline-errors" role="alert" aria-live="polite" style="display:none;margin-bottom:.5rem"></div>

    <!-- Search / filters toolbar -->
    <form method="get" class="toolbar" role="search" aria-label="Filter transactions" id="filters-form">

      <div class="field-group search-field">
        <label for="q" class="form-label sr-only">Search</label>
        <input id="q" class="form-input" type="text" name="q" placeholder="Search description or category" value="{{ q }}" style="color:var(--brand); background:#fff;" />
      </div>

      <div class="field-group start-field">
        <label for="start_date" class="sr-only">Start date</label>
        <input id="start_date" name="start_date" type="text" class="form-input form-date" value="{{ start_date }}" placeholder="Start date" style="color:var(--brand); background:#fff;" />
      </div>

      <div class="field-group end-field">
        <label for="end_date" class="sr-only">End date</label>
        <input id="end_date" name="end_date" type="text" class="form-input form-date" value="{{ end_date }}" placeholder="End date" style="color:var(--brand); background:#fff;" />
      </div>

      <div class="field-group dir-field">
        <label for="direction" class="form-label sr-only">Direction</label>
        <select id="direction" name="direction" class="form-select">
          {% if direction == 'inflow' %}
            <option value="">All</option>
            <option value="inflow" selected>Inflow</option>
            <option value="outflow">Outflow</option>
          {% elif direction == 'outflow' %}
            <option value="">All</option>
            <option value="inflow">Inflow</option>
            <option value="outflow" selected>Outflow</option>
          {% else %}
            <option value="" selected>All</option>
            <option value="inflow">Inflow</option>
            <option value="outflow">Outflow</option>
          {% endif %}
        </select>
      </div>

      <div class="field-group sort-field">
        <label for="sort" class="form-label sr-only">Sort</label>
        <select id="sort" name="sort" class="form-select">
          {% if sort == 'date' %}
            <option value="" >Date (default)</option>
            <option value="date" selected>Date ↑</option>
            <option value="-date">Date ↓</option>
            <option value="amount">Amount ↑</option>
            <option value="-amount">Amount ↓</option>
          {% elif sort == '-date' %}
            <option value="" >Date (default)</option>
            <option value="date">Date ↑</option>
            <option value="-date" selected>Date ↓</option>
            <option value="amount">Amount ↑</option>
            <option value="-amount">Amount ↓</option>
          {% elif sort == 'amount' %}
            <option value="" >Date (default)</option>
            <option value="date">Date ↑</option>
            <option value="-date">Date ↓</option>
            <option value="amount" selected>Amount ↑</option>
            <option value="-amount">Amount ↓</option>
          {% elif sort == '-amount' %}
            <option value="" >Date (default)</option>
            <option value="date">Date ↑</option>
            <option value="-date">Date ↓</option>
            <option value="amount">Amount ↑</option>
            <option value="-amount" selected>Amount ↓</option>
          {% else %}
            <option value="" selected>Date (default)</option>
            <option value="date">Date ↑</option>
            <option value="-date">Date ↓</option>
            <option value="amount">Amount ↑</option>
            <option value="-amount">Amount ↓</option>
          {% endif %}
        </select>
      </div>

      <!-- Actions at the end: Reset & Apply (compact) -->
      <div class="toolbar-actions" style="display:flex; gap:.5rem; align-items:center;">
        <button id="reset-filters" type="button" class="btn" aria-label="Reset filters">Reset Filters</button>
        <button class="btn btn-primary" type="submit">Apply</button>
      </div>

    </form>

    <!-- Secondary toolbar placed after the form so it appears under Reset/Apply and is right-aligned -->
    <div class="toolbar-secondary" style="display:flex; justify-content:flex-end;">
      {% if request.user.is_authenticated %}
        <button id="add-tx-btn" type="button" class="btn btn-primary">Add Transaction</button>
      {% endif %}
      <button id="columns-btn" type="button" class="btn" aria-haspopup="dialog">Columns</button>
      <button id="edit-selected" type="button" class="btn" disabled>Edit</button>
      <button id="delete-selected" type="button" class="btn" disabled>Delete</button>
    </div>


    <div class="tablewrap mt-1">
      <table class="preview-table">
        <thead>
          <tr>
            <th style="width:36px"><input id="select-all" type="checkbox" aria-label="Select all"></th>
            {% for col in columns %}
              {% if col == 'date' %}
                <th data-col="date" style="width:120px">{{ column_labels.date }}</th>
              {% elif col == 'description' %}
                <th data-col="description">{{ column_labels.description }}</th>
              {% elif col == 'category' %}
                <th data-col="category" style="width:180px">{{ column_labels.category }}</th>
              {% elif col == 'subcategory' %}
                <th data-col="subcategory">{{ column_labels.subcategory }}</th>
              {% elif col == 'amount' %}
                <th data-col="amount" style="text-align:right; width:140px">{{ column_labels.amount }}</th>
              {% elif col == 'direction' %}
                <th data-col="direction" style="width:120px">{{ column_labels.direction }}</th>
              {% elif col == 'account' %}
                <th data-col="account">{{ column_labels.account }}</th>
              {% elif col == 'source' %}
                <th data-col="source">{{ column_labels.source }}</th>
              {% elif col == 'created_at' %}
                <th data-col="created_at">{{ column_labels.created_at }}</th>
              {% elif col == 'updated_at' %}
                <th data-col="updated_at">{{ column_labels.updated_at }}</th>
              {% endif %}
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for t in page.object_list %}
            <tr>
              <td>
                <input class="row-select"
                       data-id="{{ t.id }}"
                       data-date="{{ t.date|date:'Y-m-d' }}"
                       data-description="{{ t.description|escape }}"
                       data-amount="{{ t.amount }}"
                       data-direction="{{ t.direction }}"
                       data-category="{{ t.category|escape }}"
                       data-subcategory="{{ t.subcategory|escape }}"
                       type="checkbox" aria-label="Select transaction {{ t.id }}">
              </td>
              {% for col in columns %}
                {% if col == 'date' %}
                  <td data-col="date">{{ t.date|date:"M. d, Y" }}</td>
                {% elif col == 'description' %}
                  <td data-col="description">{{ t.description }}</td>
                {% elif col == 'category' %}
                  <td data-col="category">{{ t.category }}</td>
                {% elif col == 'subcategory' %}
                  <td data-col="subcategory">{{ t.subcategory }}</td>
                {% elif col == 'amount' %}
                  <td data-col="amount" style="text-align:right">{{ t.amount }}</td>
                {% elif col == 'direction' %}
                  <td data-col="direction">{{ t.direction }}</td>
                {% elif col == 'account' %}
                  <td data-col="account">{{ t.account }}</td>
                {% elif col == 'source' %}
                  <td data-col="source">{{ t.source }}</td>
                {% elif col == 'created_at' %}
                  <td data-col="created_at">{{ t.created_at }}</td>
                {% elif col == 'updated_at' %}
                  <td data-col="updated_at">{{ t.updated_at }}</td>
                {% endif %}
              {% endfor %}
             </tr>
           {% empty %}
             <tr><td colspan="{{ columns|length|add:'1' }}">No transactions found.</td></tr>
           {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="mt-1 pagination-row">
      <div class="muted">
        Page {{ page.number }} of {{ page.paginator.num_pages }} — {{ page.paginator.count }} total
      </div>
      <div class="pagination">
        {% if page.has_previous %}
          <a class="btn" href="?page=1&{{ params }}">First</a>
          <a class="btn" href="?page={{ page.previous_page_number }}&{{ params }}">Previous</a>
        {% endif %}
        {% if page.has_next %}
          <a class="btn" href="?page={{ page.next_page_number }}&{{ params }}">Next</a>
          <a class="btn" href="?page={{ page.paginator.num_pages }}&{{ params }}">Last</a>
        {% endif %}
      </div>
    </div>

  </div>

  <!-- Delete confirmation modal (simple in-app modal) -->
  <div id="delete-modal" class="modal" role="dialog" aria-hidden="true" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); align-items:center; justify-content:center;">
    <div role="document" class="card" style="max-width:520px; margin:auto;">
      <div style="padding:1rem">
        <h2>Confirm deletion</h2>
        <p id="delete-modal-count"></p>
        <div style="display:flex; gap:.5rem;">
          <form id="delete-form" method="post" action="">
            {% csrf_token %}
            <input type="hidden" name="next" id="delete-next" value="{{ params }}">
            <input type="hidden" name="ids" id="delete-ids" value="">
            <button class="btn btn-primary" type="submit">Delete</button>
            <button id="delete-cancel" class="btn" type="button">Cancel</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Bulk Edit modal -->
   <div id="bulk-edit-modal" class="modal" role="dialog" aria-hidden="true" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); align-items:center; justify-content:center;">
     <div role="document" class="card" style="max-width:680px; margin:auto;">
       <div style="padding:1rem">
        <h2 id="bulk-edit-title">Bulk edit transactions</h2>
         <p id="bulk-edit-count"></p>
         <form id="bulk-edit-form" method="post" action="/transactions/bulk_edit/">
          {% csrf_token %}
          <input type="hidden" name="ids" id="bulk-edit-ids" value="">
          <input type="hidden" name="next" id="bulk-edit-next" value="{{ params }}">

          <div style="display:grid; grid-template-columns:1fr 1fr; gap:.75rem;">
            <div>
              <label for="bulk_date">Date (YYYY-MM-DD)</label>
              <input id="bulk_date" name="date" class="form-input form-date" placeholder="YYYY-MM-DD">
            </div>
            <div>
              <label for="bulk_amount">Amount</label>
              <input id="bulk_amount" name="amount" class="form-input" placeholder="Amount">
            </div>
            <div style="grid-column:1/-1">
              <label for="bulk_description">Description</label>
              <input id="bulk_description" name="description" class="form-input" placeholder="Description (applied to all if set)">
            </div>
            <div>
              <label for="bulk_direction">Direction</label>
              <select id="bulk_direction" name="direction" class="form-select">
                <option value="">(no change)</option>
                <option value="inflow">Inflow</option>
                <option value="outflow">Outflow</option>
              </select>
            </div>
            <div>
              <label for="bulk_category">Category</label>
              <input id="bulk_category" name="category" class="form-input" placeholder="Category">
            </div>
            <div>
              <label for="bulk_subcategory">Subcategory</label>
              <input id="bulk_subcategory" name="subcategory" class="form-input" placeholder="Subcategory">
            </div>
          </div>

          <div style="margin-top:1rem; display:flex; gap:.5rem; justify-content:flex-end;">
            <button id="bulk-edit-submit" class="btn btn-primary" type="submit">Apply changes <span id="bulk-spinner" style="display:none;margin-left:.5rem" aria-hidden="true"><span class="modal-spinner"></span></span></button>
            <button id="bulk-edit-cancel" class="btn" type="button">Cancel</button>
          </div>
         </form>
       </div>
     </div>
   </div>

  <!-- Columns modal -->
  <div id="columns-modal" class="modal" role="dialog" aria-hidden="true" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.35); align-items:center; justify-content:center;">
    <div role="document" class="card" style="max-width:520px; margin:auto;">
      <div style="padding:1rem">
        <h2>Choose columns</h2>
        <form id="columns-form">
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:.5rem; margin-top:.5rem;">
            {% for opt in all_columns %}
              <label style="display:flex; align-items:center; gap:.5rem;">
                {% if opt in columns %}
                  <input type="checkbox" name="columns" value="{{ opt }}" checked>
                {% else %}
                  <input type="checkbox" name="columns" value="{{ opt }}">
                {% endif %}
                {% if opt == 'date' %}Date{% elif opt == 'description' %}Description{% elif opt == 'category' %}Category{% elif opt == 'subcategory' %}Subcategory{% elif opt == 'amount' %}Amount{% elif opt == 'direction' %}Direction{% elif opt == 'account' %}Account{% elif opt == 'source' %}Source{% elif opt == 'created_at' %}Created{% elif opt == 'updated_at' %}Updated{% endif %}
              </label>
            {% endfor %}
          </div>
          <div style="display:flex; justify-content:flex-end; gap:.5rem; margin-top:1rem;">
            <button id="columns-save" type="button" class="btn btn-primary">Save</button>
            <button id="columns-cancel" type="button" class="btn">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- inline modal-level error container -->
  <div id="modal-global-error" class="modal-errors" style="display:none; margin: .5rem 0 0 0"></div>

  {% if request.user.is_authenticated %}
  <!-- Add Transaction modal (replaces the Add Transaction card from upload page) -->
  <div id="add-tx-modal" class="modal" role="dialog" aria-hidden="true" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.35); align-items:center; justify-content:center;">
    <div role="document" class="card" style="max-width:520px; margin:auto;">
      <div style="padding:1rem">
        <h2>Add Transaction</h2>
        <div id="add-modal-errors" class="inline-errors" role="alert" aria-live="polite" style="margin-bottom:.5rem; display:none"></div>
        <form id="add-tx-form-modal" method="post">
          {% csrf_token %}
          <input type="hidden" name="action" value="add_tx">
          <div class="form-row">
            <label class="form-label" for="add-tx-date">Date</label>
            <input id="add-tx-date" class="form-input" type="text" name="date" required />
          </div>

          <div class="form-row">
            <label class="form-label" for="add-tx-desc">Description</label>
            <input id="add-tx-desc" class="form-input" type="text" name="description" maxlength="512" required />
          </div>

          <div class="form-row" style="display:flex; gap:.75rem;">
            <div style="flex:1">
              <label class="form-label" for="add-tx-amount">Amount</label>
              <input id="add-tx-amount" class="form-input" type="text" name="amount" placeholder="e.g. 123.45" required />
            </div>

            <div style="width:160px;">
              <label class="form-label" for="add-tx-direction">Direction</label>
              <select id="add-tx-direction" class="form-select" name="direction">
                <option value="inflow">Inflow</option>
                <option value="outflow">Outflow</option>
              </select>
            </div>
          </div>

          <div class="form-row" style="display:flex; gap:.75rem;">
            <div style="flex:1">
              <label class="form-label" for="add-tx-category">Category</label>
              <input id="add-tx-category" class="form-input" type="text" name="category" />
            </div>
            <div style="flex:1">
              <label class="form-label" for="add-tx-subcategory">Subcategory</label>
              <input id="add-tx-subcategory" class="form-input" type="text" name="subcategory" />
            </div>
          </div>


          <div style="margin-top:1rem; display:flex; gap:.5rem; justify-content:flex-end;">
            <button id="add-tx-submit" class="btn btn-primary" type="submit">Add transaction</button>
            <button id="add-tx-cancel" class="btn" type="button">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Embed data as JSON (no inline executable JS) -->
  {{ columns|length|json_script:"table-data" }}

{% endblock %}

{% block scripts %}
<!--<script src="{% static 'app_web/dashboard.js' %}"></script>-->
<script src="{% static 'app_web/transactions.js' %}"></script>
   <script>
     // Initialize flatpickr on dashboard date inputs to match transactions styling & behavior
     (function(){
       document.addEventListener('DOMContentLoaded', function(){
         if(window.flatpickr){
           var opts = { dateFormat: 'Y-m-d', allowInput: true };
           flatpickr('#start_date', opts);
           flatpickr('#end_date', opts);
           flatpickr('#add-tx-date', opts);
         }
       });
     })();
   </script>
  <!-- Fallback: attach essential button handlers if the main transactions.js didn't run -->
  <script>
    (function(){
      try{
        if(window._txFallbackInit) return; window._txFallbackInit = true;
        const $ = s => document.querySelector(s);
        const $$ = s => Array.from(document.querySelectorAll(s));
        const show = id => { const el = document.getElementById(id); if(el){ el.style.display='flex'; el.setAttribute('aria-hidden','false'); } };
        const hide = id => { const el = document.getElementById(id); if(el){ el.style.display='none'; el.setAttribute('aria-hidden','true'); } };
        const addBtn = $('#add-tx-btn'); if(addBtn) addBtn.addEventListener('click', ()=> show('add-tx-modal'));
        const addCancel = $('#add-tx-cancel'); if(addCancel) addCancel.addEventListener('click', ()=> hide('add-tx-modal'));
        const colsBtn = $('#columns-btn'); if(colsBtn) colsBtn.addEventListener('click', ()=> show('columns-modal'));
        const colsCancel = $('#columns-cancel'); if(colsCancel) colsCancel.addEventListener('click', ()=> hide('columns-modal'));
        const delBtn = $('#delete-selected'); if(delBtn) delBtn.addEventListener('click', ()=>{ const sel = $$('.row-select').filter(cb=>cb.checked).map(cb=>cb.dataset.id); if(!sel.length) return; const ids = $('#delete-ids'); const count = $('#delete-modal-count'); if(ids) ids.value = sel.join(','); if(count) count.textContent = sel.length + ' transactions will be deleted'; show('delete-modal'); });
        const delCancel = $('#delete-cancel'); if(delCancel) delCancel.addEventListener('click', ()=> hide('delete-modal'));
        const editBtn = $('#edit-selected'); if(editBtn) editBtn.addEventListener('click', ()=>{ const sel = $$('.row-select').filter(cb=>cb.checked).map(cb=>cb.dataset.id); if(!sel.length) return; const ids = $('#bulk-edit-ids'); const title = $('#bulk-edit-title'); if(ids) ids.value = sel.join(','); if(title) title.textContent = sel.length === 1 ? 'Edit transaction' : 'Bulk edit transactions'; show('bulk-edit-modal'); });
        const resetBtn = $('#reset-filters'); if(resetBtn) resetBtn.addEventListener('click', ()=>{ const f = $('#filters-form'); if(!f) return; Array.from(f.querySelectorAll('input[name], select[name]')).forEach(i=>{ if(i.name) i.value=''; }); f.submit(); });
      }catch(e){ console.error('transactions fallback init error', e); }
    })();
  </script>
{% endblock %}
