{% extends "base.html" %} 
{% load static humanize %}
{% block title %}{{ title|default:"Projects" }} ‚Äî Finance Insights{% endblock %}

{% block head_extra %}
<!-- Flatpickr for date pickers -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<!-- Project Styles -->
<link rel="stylesheet" href="{% static 'app_web/projects.css' %}?v=4">
{% endblock %}

{% block content %}
<div class="projects-container">
  <div class="project-header">
    <div>
      <h1>Project Management</h1>
      <p class="subtitle">Manage projects, sub-projects, milestones, and budgets</p>
    </div>
    <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
      <button id="toggle-view-btn" class="btn" onclick="toggleView()">
        <span id="view-icon">üìä</span> <span id="view-text">Tree View</span>
      </button>
      <button id="bulk-delete-btn" class="btn" style="background: #ef4444; color: white; display: none;" onclick="confirmBulkDelete()">
        Delete Selected (<span id="selected-count">0</span>)
      </button>
      <button class="btn btn-primary" onclick="openAddProjectModal()">+ Add Project</button>
      <a href="{% url 'app_web:dashboard' %}" class="btn">‚Üê Dashboard</a>
    </div>
  </div>

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }}">{{ message }}</div>
    {% endfor %}
  {% endif %}

  <!-- Project Filters -->
  <div class="project-filters">
    <div class="field-group">
      <label>Status</label>
      <select class="form-select" id="filter-status">
        <option value="all">All Projects</option>
        <option value="active">Active</option>
        <option value="completed">Completed</option>
        <option value="on-hold">On Hold</option>
      </select>
    </div>

    <div class="field-group">
      <label>View</label>
      <select class="form-select" id="filter-level">
        <option value="all">All Levels</option>
        <option value="0">Parent Projects Only</option>
        <option value="1">Sub-Projects Only</option>
        <option value="2">Tasks Only</option>
      </select>
    </div>

    <div class="field-group">
      <label>Search</label>
      <input type="text" class="form-input" id="search-input" placeholder="Search projects...">
    </div>
  </div>

  <!-- Projects Grid (will be populated by JavaScript) -->
  <div id="projects-container" class="projects-grid"></div>

  <div id="empty-state" class="empty-state" style="display: none;">
    <h3>No projects yet</h3>
    <p>Create your first project to start tracking finances by project, client, or department.</p>
    <button class="btn btn-primary" onclick="openAddProjectModal()">+ Create Your First Project</button>
  </div>
</div>

<!-- Add/Edit Project Modal -->
<div class="modal-backdrop" id="project-modal">
  <div class="modal">
    <div class="modal-header">
      <h2 id="modal-title">Add New Project</h2>
      <button class="modal-close" onclick="closeProjectModal()">&times;</button>
    </div>
    <form id="project-form" method="POST">
      {% csrf_token %}
      <input type="hidden" name="action" id="form-action" value="create">
      <input type="hidden" name="project_id" id="form-project-id">

      <div class="field">
        <label for="project-name">Project Name <span class="text-danger">*</span></label>
        <input type="text" id="project-name" name="name" class="form-input" required placeholder="e.g., Q4 Marketing Campaign">
      </div>

      <div class="field">
        <label for="project-description">Description</label>
        <textarea id="project-description" name="description" class="form-textarea" rows="3" placeholder="Project details and objectives..."></textarea>
      </div>

      <div class="field" id="parent-project-field">
        <label for="parent-project">Parent Project (Optional)</label>
        <input type="hidden" id="parent-project-hidden" name="parent_project" value="">
        <select id="parent-project" class="form-select">
          <option value="">None - This is a parent project</option>
          {% for parent in parent_projects %}
            <option value="{{ parent.id }}" data-level="{{ parent.level }}">
              {% if parent.level == 0 %}üìÅ{% elif parent.level == 1 %}üìÑ{% endif %} {{ parent.name }}
            </option>
          {% endfor %}
        </select>
        <p class="field-help">Select a parent to create a sub-project (max 3 levels deep)</p>
      </div>

      <div class="form-row">
        <div class="field">
          <label for="project-budget">Budget</label>
          <input type="number" id="project-budget" name="budget" class="form-input" step="0.01" min="0" placeholder="0.00">
        </div>

        <div class="field">
          <label for="project-status">Status</label>
          <select id="project-status" name="status" class="form-select">
            <option value="active">Active</option>
            <option value="on-hold">On Hold</option>
            <option value="completed">Completed</option>
          </select>
        </div>
      </div>

      <div class="field">
        <label for="project-color">Color</label>
        <input type="hidden" id="project-color" name="color" value="#3b82f6">
        <div class="color-picker">
          <div class="color-preview" id="color-preview" style="background: #3b82f6;"></div>
          <div class="color-palette">
            <button type="button" class="color-option" data-color="#3b82f6" style="background: #3b82f6;" title="Blue"></button>
            <button type="button" class="color-option" data-color="#10b981" style="background: #10b981;" title="Green"></button>
            <button type="button" class="color-option" data-color="#f59e0b" style="background: #f59e0b;" title="Amber"></button>
            <button type="button" class="color-option" data-color="#ef4444" style="background: #ef4444;" title="Red"></button>
            <button type="button" class="color-option" data-color="#8b5cf6" style="background: #8b5cf6;" title="Purple"></button>
            <button type="button" class="color-option" data-color="#ec4899" style="background: #ec4899;" title="Pink"></button>
            <button type="button" class="color-option" data-color="#06b6d4" style="background: #06b6d4;" title="Cyan"></button>
            <button type="button" class="color-option" data-color="#f97316" style="background: #f97316;" title="Orange"></button>
            <button type="button" class="color-option" data-color="#14b8a6" style="background: #14b8a6;" title="Teal"></button>
            <button type="button" class="color-option" data-color="#6366f1" style="background: #6366f1;" title="Indigo"></button>
            <button type="button" class="color-option" data-color="#84cc16" style="background: #84cc16;" title="Lime"></button>
            <button type="button" class="color-option" data-color="#64748b" style="background: #64748b;" title="Slate"></button>
          </div>
        </div>
      </div>

      <div class="form-row">
        <div class="field">
          <label for="project-start-date">Start Date</label>
          <input type="text" id="project-start-date" name="start_date" class="form-input date-picker" placeholder="Select start date">
        </div>

        <div class="field">
          <label for="project-end-date">End Date</label>
          <input type="text" id="project-end-date" name="end_date" class="form-input date-picker" placeholder="Select end date">
        </div>
      </div>

      <div class="field">
        <label>Track Labels</label>
        <div class="labels-container" id="labels-container">
          {% for label in labels %}
            <label class="label-checkbox">
              <input type="checkbox" name="labels" value="{{ label.id }}">
              <span class="label-tag" style="background: {{ label.color }}20; color: {{ label.color }}; border: 1px solid {{ label.color }}40;">
                {{ label.name }}
              </span>
            </label>
          {% empty %}
            <p class="text-muted">No labels available. <a href="{% url 'app_web:transactions' %}">Create labels first</a></p>
          {% endfor %}
        </div>
        <p class="field-help">Transactions with these labels will automatically be included in this project</p>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn" onclick="closeProjectModal()">Cancel</button>
        <button type="submit" class="btn btn-primary" id="submit-btn">Create Project</button>
      </div>
    </form>
  </div>
</div>

<!-- Project Details Modal -->
<div class="modal-backdrop" id="details-modal">
  <div class="modal modal-large">
    <div class="modal-header">
      <h2 id="details-project-name">Project Details</h2>
      <button class="modal-close" onclick="closeDetailsModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="details-tabs">
        <button class="tab-btn active" onclick="switchTab('overview')">Overview</button>
        <button class="tab-btn" onclick="switchTab('financials')">Financials</button>
        <button class="tab-btn" onclick="switchTab('milestones')">Milestones</button>
        <button class="tab-btn" onclick="switchTab('categories')">Budget Categories</button>
        <button class="tab-btn" onclick="switchTab('activity')">Activity</button>
      </div>
      <div id="details-content" class="details-content">
        <div class="loading">Loading project details...</div>
      </div>
    </div>
  </div>
</div>

<!-- Pass data to JavaScript -->
<script>
  window.projectsData = '{{ projects|escapejs }}';
</script>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="{% static 'app_web/projects.js' %}?v=4"></script>
{% endblock %}

